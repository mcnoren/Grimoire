<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grimoire V27 - Expanded Roles</title>
    <style>
        :root {
            --bg-dark: #0f0f13;
            --bg-panel: #1e1e24;
            --accent: #7c4dff;
            --text-main: #eceff1;
            --text-muted: #90a4ae;
            --border: #2c2e35;
            
            --town-color: #2b7de9;
            --out-color: #2be9e9;
            --min-color: #e9952b;
            --dem-color: #e92b2b;
            --trav-color: #d12be9;
            --fab-color: #e9e22b;
            --lor-color: #e96b2b;
            --rem-color: #ffd700;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn {
            background: var(--accent); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #333; color: #555; cursor: not-allowed; }
        .btn-red { background: var(--dem-color); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #aaa; }
        .btn-outline:hover { background: rgba(255,255,255,0.1); color: white; }

        /* --- SCREENS --- */
        .screen { position: fixed; inset: 0; background: var(--bg-dark); z-index: 10; display: flex; flex-direction: column; }

        /* 1. SPLASH SCREEN */
        #screen-splash { 
            align-items: center; z-index: 50; overflow-y: auto; padding: 40px 20px;
            background: radial-gradient(circle at center, #1a1a20 0%, #050505 100%);
        }
        .hero-title {
            font-size: 4rem; margin: 0 0 10px 0; 
            background: linear-gradient(to right, #7c4dff, #2b7de9);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 900; letter-spacing: -2px; text-align: center;
        }
        
        .splash-section { width: 100%; max-width: 900px; margin-bottom: 40px; }
        .section-title { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        
        .script-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        .script-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px;
            padding: 25px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; height: 140px; justify-content: center; text-align: center;
        }
        .script-card:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); transform: translateY(-3px); }
        .script-card h3 { margin: 0 0 5px 0; font-size: 1.4rem; }
        .script-card p { margin: 0; font-size: 0.8rem; color: #777; }
        
        .card-official { border-left: 4px solid var(--accent); }
        .card-custom { border-left: 4px solid var(--town-color); }
        .card-new { border: 2px dashed #444; background: transparent; display: flex; align-items: center; justify-content: center; color: #666; }
        .card-new:hover { border-color: var(--accent); color: var(--accent); }

        /* 1.5 SCRIPT PREVIEW MODAL */
        #modal-preview .preview-content { display: flex; flex-direction: column; height: 100%; }
        .preview-lists { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; text-align: left; }
        .preview-col h4 { border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; color: var(--text-muted); }
        .preview-item { font-size: 0.9rem; margin-bottom: 4px; display: flex; gap: 8px; align-items: center; }
        .preview-icon { width: 20px; height: 20px; object-fit: contain; }

        /* 2. BUILDER */
        #screen-builder { padding: 20px; }
        .builder-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .title-input { background: transparent; border: none; font-size: 1.5rem; color: white; font-weight: bold; border-bottom: 2px solid #444; width: 300px; }
        .title-input:focus { outline: none; border-color: var(--accent); }
        
        .builder-body { display: flex; gap: 20px; flex-grow: 1; overflow: hidden; }
        .library-panel { width: 340px; display: flex; flex-direction: column; border-right: 1px solid var(--border); padding-right: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        
        /* Library Tabs */
        .lib-tabs { display: flex; gap: 5px; border-bottom: 1px solid var(--border); margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .lib-tab { 
            background: transparent; border: none; color: #888; white-space: nowrap;
            padding: 8px 10px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
            border-bottom: 2px solid transparent; transition: 0.2s; flex-shrink: 0;
        }
        .lib-tab:hover { color: white; background: rgba(255,255,255,0.05); }
        .lib-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(255,255,255,0.05); }

        .library-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        /* New Library Styles */
        .lib-section { margin-bottom: 20px; }
        .lib-header { font-size: 1rem; font-weight: bold; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; display: none; }
        .lib-type-header { font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 4px 5px; font-weight: bold; text-transform: uppercase; }
        
        .build-item { 
            padding: 6px 10px; border-radius: 4px; margin-bottom: 2px; font-size: 0.9rem; 
            display: flex; align-items: center; justify-content: space-between; 
            background: rgba(255,255,255,0.03); transition: 0.1s;
        }
        .build-item:hover { background: #333; }
        .build-item.added { background: #333; opacity: 0.6; border-left: 3px solid var(--accent); }
        .build-left { display: flex; align-items: center; gap: 8px; flex: 1; cursor: pointer; }
        .build-eye { padding: 4px; cursor: pointer; opacity: 0.4; font-size: 1rem; }
        .build-eye:hover { opacity: 1; color: var(--accent); }

        .script-panel { flex-grow: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; overflow-y: auto; padding-left: 10px; }
        /* Expanded Grid for Builder to 7 cols if needed, but we scroll horizontally? No, lets stack Trav/Fab/Lor */
        
        .script-col { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; min-width: 150px; }
        .script-col h4 { margin-top: 0; color: var(--text-muted); border-bottom: 1px solid #333; padding-bottom: 5px; text-align: center; }
        .script-col div { padding: 5px; border-bottom: 1px solid #222; font-size: 0.9rem; }

        /* 3. SETUP & GAME (Shared Styles) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; border-bottom: 1px solid var(--border); }
        .grid-scroll-area { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 40px; }
        .role-item { padding: 8px 12px; margin-bottom: 8px; background: #23242a; border-radius: 6px; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between; }
        .role-item.selected { background: var(--accent); color: white; }
        .role-item.disabled { opacity: 0.3; pointer-events: none; }
        .role-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .setup-icon { width: 30px; height: 30px; object-fit: contain; }
        .eye-btn { padding: 5px; opacity: 0.5; font-size: 1.2rem; }

        /* Stepper & Pills */
        .stepper { display: flex; align-items: center; background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border); }
        .stepper button { background: transparent; border: none; color: white; font-size: 1.5rem; padding: 5px 20px; cursor: pointer; }
        .stepper span { font-size: 1.5rem; font-weight: bold; min-width: 50px; text-align: center; }
        .count-pill { background: var(--bg-panel); padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); font-weight: bold; }
        .count-pill.valid { color: var(--town-color); border-color: var(--town-color); }
        .count-pill.invalid { color: var(--dem-color); border-color: var(--dem-color); opacity: 0.6; }

        /* GAME LAYOUT */
        #screen-game { display: flex; flex-direction: row; }
        #sidebar { width: 340px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; z-index: 100; }
        #input-name { width: 100%; background: #111; border: 1px solid var(--border); color: white; padding: 15px; font-size: 1.1rem; border-radius: 8px; margin-bottom: 10px; }
        #game-board { flex-grow: 1; position: relative; background: radial-gradient(circle at center, #1a1b20 0%, #0f0f13 100%); overflow: hidden; }
        #town-circle-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 600px; border: 2px dashed #333; border-radius: 50%; pointer-events: none; }

        /* TOKEN */
        .token { position: absolute; width: 110px; height: 110px; background: #25262c; border: 3px solid #555; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.6); z-index: 20; transition: border-color 0.2s, transform 0.2s; }
        .token.draggable { cursor: grab; }
        .token.draggable:active { cursor: grabbing; z-index: 100; transform: scale(1.05); }
        .token.good { border-color: var(--town-color); background: #182230; }
        .token.evil { border-color: var(--dem-color); background: #301818; }
        .token.dead { filter: grayscale(100%); opacity: 0.7; border-style: dotted; }
        .token-icon-wrap { width: 50px; height: 50px; position: relative; display: flex; justify-content: center; align-items: center; margin: 0 auto; pointer-events: none; }
        .token-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); display: block; }
        .token-name { font-weight: 700; font-size: 0.85rem; pointer-events: none; margin-top: 5px; text-align: center; line-height: 1.1; max-width: 90%; }
        
        .token-ctrl { position: absolute; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .ctrl-eye { top: 0; right: -5px; background: var(--accent); color: white; font-size: 14px; border: 2px solid var(--bg-dark); }
        .ctrl-del { top: 0; left: -5px; background: var(--dem-color); color: white; font-size: 12px; border: 2px solid var(--bg-dark); display: none; }
        .ctrl-vote { bottom: -15px; left: 50%; transform: translateX(-50%); background: white; border: 3px solid #333; width: 30px; height: 30px; z-index: 50; cursor: pointer; }
        .ctrl-vote.used { background: #444; border-color: #666; }
        
        .token-reminders { position: absolute; top: -10px; width: 140%; display: flex; justify-content: center; flex-wrap: wrap; gap: 2px; pointer-events: none; }
        .reminder-tag { background: var(--rem-color); color: #000; font-size: 0.6rem; font-weight: bold; padding: 2px 6px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        body.edit-mode .ctrl-del { display: flex; }
        body.edit-mode .token { animation: shake 0.3s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(1deg); } 75% { transform: rotate(-1deg); } }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        
        /* Card View Styles */
        .card-view { 
            width: 90vw; max-width: 400px; 
            background: #23242a; 
            color: #eceff1; 
            border-radius: 16px; 
            padding: 30px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 3px solid #444; 
        }
        .card-img-lg { width: 120px; height: 120px; object-fit: contain; margin: 0 auto 15px auto; display: block; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        .card-title { font-size: 2rem; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        .card-type { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: #aaa; margin-bottom: 20px; font-weight: bold; }
        .card-desc { font-size: 1.1rem; line-height: 1.5; font-style: italic; color: #ddd; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; }
        
        .edit-box { background: var(--bg-panel); padding: 25px; border-radius: 16px; width: 400px; max-width: 95vw; border: 1px solid var(--border); box-shadow: 0 10px 40px black; }
        .edit-header-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--border); color: white; font-size: 1.5rem; font-weight: bold; padding: 5px; margin-bottom: 20px; text-align: center; }
        .edit-header-input:focus { outline: none; border-color: var(--accent); }
        
        .role-changer-btn { display: flex; align-items: center; justify-content: center; gap: 15px; background: #2a2a30; width: 100%; padding: 15px; border-radius: 10px; cursor: pointer; border: 1px solid var(--border); margin-bottom: 20px; transition: 0.2s; }
        .role-changer-btn:hover { background: #333; border-color: var(--accent); }
        .role-changer-icon { width: 40px; height: 40px; object-fit: contain; }
        .role-changer-text { font-size: 1.2rem; font-weight: bold; }

        .toggle-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .toggle-container { flex: 1; background: #111; border-radius: 30px; height: 40px; position: relative; display: flex; cursor: pointer; border: 1px solid var(--border); overflow: hidden; }
        .toggle-opt { flex: 1; z-index: 2; text-align: center; line-height: 40px; font-weight: bold; font-size: 0.8rem; transition: color 0.2s; }
        .toggle-slider { position: absolute; width: 50%; height: 100%; border-radius: 30px; transition: 0.3s; z-index: 1; }
        .toggle-alive .toggle-slider { background: #4caf50; left: 0; }
        .toggle-alive.dead-state .toggle-slider { background: #555; left: 50%; }
        .toggle-align .toggle-slider { background: var(--town-color); left: 0; }
        .toggle-align.evil-state .toggle-slider { background: var(--dem-color); left: 50%; }

        .reminder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .rem-btn { background: #2a2a2a; border: 1px solid #444; color: #888; padding: 10px; font-size: 0.85rem; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .rem-btn.selected { background: var(--active-btn); border-color: var(--active-btn); color: white; }

        .fab-container { position: absolute; top: 20px; left: 20px; display: flex; gap: 10px; z-index: 50; }
        .fab { background: #333; color: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; font-weight: bold; border: 1px solid #555; }
        .fab.active { background: var(--dem-color); border-color: var(--dem-color); }

        .badge-icon { width: 100%; height: 100%; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; color: white; border: 2px solid rgba(255,255,255,0.2); }
        .b-town { background: linear-gradient(135deg, #2b7de9, #1a4c8f); }
        .b-out { background: linear-gradient(135deg, #2be9e9, #1a8f8f); color: #000; }
        .b-min { background: linear-gradient(135deg, #e9952b, #8f5a1a); }
        .b-dem { background: linear-gradient(135deg, #e92b2b, #8f1a1a); }
        .b-trav { background: linear-gradient(135deg, #d12be9, #8f1a8f); }
        .b-fab { background: linear-gradient(135deg, #e9e22b, #8f8f1a); color: #000; }
        .b-lor { background: linear-gradient(135deg, #e96b2b, #8f3a1a); }

        /* Role Picker in Modal */
        #modal-role-picker .role-grid-full {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;
            max-height: 70vh; overflow-y: auto; padding: 10px;
        }
        .picker-item {
            background: #333; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer;
            border: 2px solid transparent; display: flex; flex-direction: column; align-items: center;
        }
        .picker-item:hover { background: #444; }
        .picker-item.active { border-color: var(--accent); background: #222; }
        .picker-icon { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .picker-name { font-size: 0.7rem; line-height: 1.1; }

        .multi-card-container { display: flex; gap: 10px; overflow-x: auto; max-width: 100%; padding: 10px; }
        .mini-card { background: #eceff1; color: #111; padding: 15px; border-radius: 8px; width: 220px; text-align: center; flex-shrink: 0; }

        /* HOVER CARD */
        .hover-card {
            position: fixed;
            width: 300px;
            background: #1a1a20; /* Dark bg */
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 20000;
            pointer-events: none; /* Let mouse pass through */
            border: 2px solid #555;
            color: #eee;
            text-align: center;
        }
        .hover-head { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; text-align: left; }
        .hover-img { width: 50px; height: 50px; object-fit: contain; }
        .hover-info h3 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .hover-info span { font-size: 0.75rem; text-transform: uppercase; color: #888; letter-spacing: 1px; font-weight: bold; }
        .hover-desc { font-size: 0.95rem; font-style: italic; line-height: 1.4; color: #ccc; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }

    </style>
    
    <script>
        // --- DATABASE LOADED FIRST ---
        // * = First Night Wake
        const DB = [
            // Trouble Brewing
            {n:"Washerwoman",t:"Townsfolk",d:"Start knowing* that 1 of 2 players is a specific Townsfolk.",f:true},
            {n:"Librarian",t:"Townsfolk",d:"Start knowing* that 1 of 2 players is a specific Outsider.",f:true},
            {n:"Investigator",t:"Townsfolk",d:"Start knowing* that 1 of 2 players is a specific Minion.",f:true},
            {n:"Chef",t:"Townsfolk",d:"Start knowing* how many pairs of evil players are neighbors.",f:true},
            {n:"Empath",t:"Townsfolk",d:"Each night, learn how many of your 2 alive neighbors are evil."},
            {n:"Fortune Teller",t:"Townsfolk",d:"Each night, choose 2 players: learn if either is a Demon. There is a good player that registers as a Demon to you."},
            {n:"Undertaker",t:"Townsfolk",d:"Each night, learn which character died by execution today."},
            {n:"Monk",t:"Townsfolk",d:"Each night*, choose a player (not yourself): they are safe from the Demon tonight."},
            {n:"Ravenkeeper",t:"Townsfolk",d:"If you die at night, you are woken to choose a player: you learn their character."},
            {n:"Virgin",t:"Townsfolk",d:"The 1st time you are nominated by a Townsfolk, you are executed if the nominee is a Townsfolk."},
            {n:"Slayer",t:"Townsfolk",d:"Once per game, during the day, publicly choose a player: if they are the Demon, they die."},
            {n:"Soldier",t:"Townsfolk",d:"You are safe from the Demon."},
            {n:"Mayor",t:"Townsfolk",d:"If no one dies by execution, you might win. If you die at night, another player might die instead."},
            {n:"Butler",t:"Outsider",d:"Each night, choose a player (not yourself): tomorrow, you may only vote if they vote too."},
            {n:"Drunk",t:"Outsider",d:"You do not know you are the Drunk. You think you are a Townsfolk, but you are not.", mod:"Is Outsider"},
            {n:"Recluse",t:"Outsider",d:"You might register as evil & as a Minion or Demon, even if dead."},
            {n:"Saint",t:"Outsider",d:"If you die by execution, your team loses."},
            {n:"Poisoner",t:"Minion",d:"Each night, choose a player: they are poisoned tonight and tomorrow day."},
            {n:"Spy",t:"Minion",d:"Each night, you see the Grimoire. You might register as good & as a Townsfolk or Outsider."},
            {n:"Scarlet Woman",t:"Minion",d:"If there are 5 or more players alive & the Demon dies, you become the Demon."},
            {n:"Baron",t:"Minion",d:"There are extra Outsiders in play.", mod:"+2 Outsiders",f:true},
            {n:"Imp",t:"Demon",d:"Each night*, choose a player: they die. If you kill yourself this way, a Minion becomes the Imp."},
            
            // Bad Moon Rising
            {n:"Grandmother",t:"Townsfolk",d:"Start knowing* a specific good player (your Grandchild). If they die by Demon, you die too.",f:true},
            {n:"Sailor",t:"Townsfolk",d:"Each night, choose a player: either you or they are drunk. You can't die."},
            {n:"Chambermaid",t:"Townsfolk",d:"Each night, choose 2 alive players (not yourself): learn how many woke tonight."},
            {n:"Exorcist",t:"Townsfolk",d:"Each night*, choose a player (not yourself): the Demon doesn't wake tonight if you chose them."},
            {n:"Innkeeper",t:"Townsfolk",d:"Each night*, choose 2 players: they are safe from the Demon. One is drunk."},
            {n:"Gambler",t:"Townsfolk",d:"Each night*, choose a player & guess their character: if you guess wrong, you die."},
            {n:"Gossip",t:"Townsfolk",d:"Each day, make a public statement. If true, a player dies tonight."},
            {n:"Courtier",t:"Townsfolk",d:"Once per game, at night, choose a character: they are drunk for 3 nights & days."},
            {n:"Professor",t:"Townsfolk",d:"Once per game, at night*, choose a dead player: if they are a Townsfolk, they are resurrected."},
            {n:"Minstrel",t:"Townsfolk",d:"When a Minion dies by execution, all other players (except Travellers) are drunk until tomorrow dusk."},
            {n:"Tea Lady",t:"Townsfolk",d:"If both your alive neighbors are good, they can't die."},
            {n:"Pacifist",t:"Townsfolk",d:"Executed good players might not die."},
            {n:"Fool",t:"Townsfolk",d:"The first time you die (except by execution), you don't die."},
            {n:"Tinker",t:"Outsider",d:"You might die at any time."},
            {n:"Moonchild",t:"Outsider",d:"When you die, choose a player: they die tonight."},
            {n:"Goon",t:"Outsider",d:"Each night, the 1st player to choose you with their ability is drunk until dusk. You become their alignment."},
            {n:"Lunatic",t:"Outsider",d:"You think you are a Demon, but you are not. The Demon knows who you are.",f:true},
            {n:"Godfather",t:"Minion",d:"Start knowing* which Outsiders are in play. If 1 died today, choose a player: they die.", mod:"+1 Outsider",f:true},
            {n:"Devils Advocate",t:"Minion",d:"Each night, choose a living player: if executed tomorrow, they don't die."},
            {n:"Assassin",t:"Minion",d:"Once per game, at night*, choose a player: they die (no protection)."},
            {n:"Mastermind",t:"Minion",d:"If the Demon dies by execution (game ends), play 1 more day. If a player is then executed, their team loses."},
            {n:"Zombuul",t:"Demon",d:"Each night*, if no one died today, choose a player: they die. 1st time you die, you live but register as dead."},
            {n:"Pukka",t:"Demon",d:"Each night, choose a player: they are poisoned. The previously poisoned player dies."},
            {n:"Shabaloth",t:"Demon",d:"Each night*, choose 2 players: they die. A dead player you chose might be resurrected."},
            {n:"Po",t:"Demon",d:"Each night*, choose a player: they die. If you chose no one last night, choose 3 players."},
            
            // Sects & Violets
            {n:"Clockmaker",t:"Townsfolk",d:"Start knowing* how many steps from the Demon to its nearest Minion.",f:true},
            {n:"Dreamer",t:"Townsfolk",d:"Each night, choose a player (not yourself/Traveller): learn 1 good and 1 evil character, 1 is true."},
            {n:"Snake Charmer",t:"Townsfolk",d:"Each night, choose a player: if they are the Demon, you become the Demon and they become the Snake Charmer."},
            {n:"Mathematician",t:"Townsfolk",d:"Each night, learn how many players' abilities malfunctioned tonight."},
            {n:"Flowergirl",t:"Townsfolk",d:"Each night, learn if the Demon voted today."},
            {n:"Town Crier",t:"Townsfolk",d:"Each night, learn if a Minion nominated today."},
            {n:"Oracle",t:"Townsfolk",d:"Each night, learn how many dead players are evil."},
            {n:"Savant",t:"Townsfolk",d:"Each day, visit the Storyteller to learn 2 things: 1 is true, 1 is false."},
            {n:"Seamstress",t:"Townsfolk",d:"Once per game, at night, choose 2 players: learn if they are the same alignment."},
            {n:"Philosopher",t:"Townsfolk",d:"Once per game, at night, choose a good character: gain that ability. If in play, they are drunk."},
            {n:"Artist",t:"Townsfolk",d:"Once per game, during the day, privately ask the Storyteller any Yes/No question."},
            {n:"Juggler",t:"Townsfolk",d:"1st day, guess up to 5 players' characters. Tonight, learn how many were correct."},
            {n:"Sage",t:"Townsfolk",d:"If the Demon kills you, you learn that 1 of 2 players is the Demon."},
            {n:"Mutant",t:"Outsider",d:"If you are 'mad' about being an Outsider, you might be executed."},
            {n:"Sweetheart",t:"Outsider",d:"When you die, 1 player is drunk from now on."},
            {n:"Barber",t:"Outsider",d:"If you die, the Demon chooses 2 players to swap characters."},
            {n:"Klutz",t:"Outsider",d:"When you learn you died, choose a living player: if they are evil, your team loses."},
            {n:"Witch",t:"Minion",d:"Each night, choose a player: if they nominate tomorrow, they die."},
            {n:"Cerebus",t:"Minion",d:"Each night, choose a player & a character: they are 'mad' they are that character tomorrow or might be executed."},
            {n:"Pit-Hag",t:"Minion",d:"Each night*, choose a player & a character: they become that character. If already in play, they are drunk."},
            {n:"Evil Twin",t:"Minion",d:"You & an opposing player know each other. If the good player is executed, evil wins. Good can't win if you both live.",f:true},
            {n:"Fang Gu",t:"Demon",d:"Each night*, choose a player: they die. The 1st Outsider you choose becomes an evil Fang Gu & you die.", mod:"+1 Outsider"},
            {n:"Vortox",t:"Demon",d:"Each night*, choose a player: they die. Townsfolk abilities yield false info. If no one is executed, evil wins."},
            {n:"No Dashii",t:"Demon",d:"Each night*, choose a player: they die. Your 2 Townsfolk neighbors are poisoned."},
            {n:"Vigormortis",t:"Demon",d:"Each night*, choose a player: they die. Minions you kill keep abilities & poison 1 neighbor."},
            
            // Travelers
            {n:"Scapegoat",t:"Traveler",d:"If a player of your alignment is executed, you might be executed instead."},
            {n:"Gunslinger",t:"Traveler",d:"Each day, after the 1st vote has been tallied, you may choose a player that voted: they die."},
            {n:"Beggar",t:"Traveler",d:"You must use a vote token to vote. If a dead player gives you theirs, you learn their alignment. You are sober & healthy."},
            {n:"Bureaucrat",t:"Traveler",d:"Each night, choose a player (not yourself): their vote counts as 3 votes tomorrow."},
            {n:"Thief",t:"Traveler",d:"Each night, choose a player (not yourself): their vote counts negatively tomorrow."},
            {n:"Butcher",t:"Traveler",d:"Each day, after the 1st execution, you nominate again."},
            {n:"Bone Collector",t:"Traveler",d:"Once per game, at night*, choose a dead player; they regain their ability until dusk."},
            {n:"Harlot",t:"Traveler",d:"Each night*, choose a living player: if they agree, you learn their character, but you both might die."},
            {n:"Barista",t:"Traveler",d:"Each night, until dusk, 1) a player becomes sober, healthy, & gets true info, or 2) their ability works twice. They learn which."},
            {n:"Deviant",t:"Traveler",d:"If you were funny today, you cannot be exiled."},
            {n:"Apprentice",t:"Traveler",d:"On your 1st night, you gain a Townsfolk ability (if good), or a Minion ability (if evil)."},
            {n:"Matron",t:"Traveler",d:"Players may not leave their seats to talk in private. Each day, you may choose up to 3 sets of 2 players to swap seats."},
            {n:"Voudon",t:"Traveler",d:"Only you & the dead can vote. They don't need a vote token to do so. A 50% majority is not required."},
            {n:"Judge",t:"Traveler",d:"Once per game, if another player nominated, you may choose to force the current execution to pass or fail."},
            {n:"Bishop",t:"Traveler",d:"Only the Storyteller can nominate. At least 1 opposing player must be nominated each day."},
            {n:"Gangster",t:"Traveler",d:"Each day, you may choose to kill a living neighbour, if your other living neighbour agrees."},
            
            // Fabled
            {n:"Doomsayer",t:"Fabled",d:"If 4 or more players live, each living player may publicly choose (once per game) that a player of their own alignment dies."},
            {n:"Angel",t:"Fabled",d:"Something bad might happen to whomever is most responsible for the death of a new player."},
            {n:"Buddhist",t:"Fabled",d:"For the first 2 minutes of each day, veteran players may not talk."},
            {n:"Hell's Librarian",t:"Fabled",d:"Something bad might happen to whomever talks when the Storyteller has asked for silence."},
            {n:"Revolutionary",t:"Fabled",d:"2 neighbouring players are known to be the same alignment. Once per game, 1 of them registers falsely."},
            {n:"Fiddler",t:"Fabled",d:"Once per game, the Demon secretly chooses an opposing player: all players choose which of these 2 players win."},
            {n:"Toymaker",t:"Fabled",d:"The Demon may choose not to attack & must do this at least once per game. Evil players get normal starting info."},
            {n:"Fibbin",t:"Fabled",d:"Once per game, 1 good player might get incorrect information."},
            {n:"Duchess",t:"Fabled",d:"Each day, 3 players may choose to visit you. At night*, each visitor learns how many visitors are evil, but 1 gets false info."},
            {n:"Sentinel",t:"Fabled",d:"There might be 1 extra or 1 fewer Outsider in play."},
            {n:"Spirit of Ivory",t:"Fabled",d:"There can't be more than 1 extra evil player."},
            {n:"Djinn",t:"Fabled",d:"Use the Djinn's special rule. All players know what it is."},
            
            // Loric
            {n:"Big Wig",t:"Loric",d:"Each nominee chooses a player: until voting, only they may speak & they are mad the nominee is good or they might die."},
            {n:"Tor",t:"Loric",d:"Players don't know their character or alignment. They learn them when they die."},
            {n:"Bootlegger",t:"Loric",d:"Homebrew characters may be in play."},
            {n:"Gardener",t:"Loric",d:"The Storyteller assigns characters & alignments."},
            {n:"Storm Catcher",t:"Loric",d:"Name a character. If in play, they are safe from the Demon, but the Demon learns who they are."},

            // Experimental
            {n:"Noble",t:"Townsfolk",d:"Start knowing* 3 players, 1 is evil.",f:true},
            {n:"Bounty Hunter",t:"Townsfolk",d:"Start knowing* 1 evil player. If the good player you know dies, you learn another.",f:true},
            {n:"Balloonist",t:"Townsfolk",d:"Each night, learn a player of a different character type than last night. [+1 Outsider]",mod:"+1 Outsider"},
            {n:"Al-Hadikhia",t:"Demon",d:"Each night*, choose 3 players. They act. If all live, all die. Else, those who chose death die."},
            {n:"Atheist",t:"Townsfolk",d:"The Storyteller can break the rules. If executed, good wins if there is no Demon."},
            {n:"Heretic",t:"Outsider",d:"Whoever wins, loses & whoever loses, wins."},
            {n:"Amnesiac",t:"Townsfolk",d:"You do not know your ability. Each day, guess your ability: you learn if you are correct."},
            {n:"Engineer",t:"Townsfolk",d:"Once per game, at night, choose which Minions or which Demon is in play."},
            {n:"Huntsman",t:"Townsfolk",d:"Once per game, at night, choose a player: if they are the Damsel, they become a not-in-play Townsfolk."},
            {n:"Legion",t:"Demon",d:"Each night*, a player might die. Executions fail if only evil voted. You register as a Minion too. (Most players are Legion).",f:true},
            {n:"Lil' Monsta",t:"Demon",d:"Each night, Minions choose who babysits Lil' Monsta & \"is the Demon\". A player dies each night*.",f:true},
            {n:"Riot",t:"Demon",d:"Nominees die, but nominate again immediately. Day 3, evil wins."},
            {n:"Widow",t:"Minion",d:"Start knowing the Grimoire. Each night, choose a player: they are poisoned. A good player knows a Widow is in play.",f:true},
            {n:"Vizier",t:"Minion",d:"You can choose to execute immediately. You know the Demon. Good players know you are the Vizier.",f:true},
            {n:"Organ Grinder",t:"Minion",d:"You cannot die. Eyes closed voting."},
            {n:"Summoner",t:"Minion",d:"Night 3, choose a player: they become a Demon. You are evil."},
            {n:"Marionette",t:"Minion",d:"You think you are a good character but you are not. The Demon knows who you are.",f:true},
            {n:"Damsel",t:"Outsider",d:"All Minions know you are in play. If a Minion guesses you, your team loses.",f:true},
            {n:"Politician",t:"Outsider",d:"If you were the player most responsible for your team losing, you win."},
            {n:"Snitch",t:"Outsider",d:"Minions get 3 bluffs.",f:true},
            {n:"Golem",t:"Outsider",d:"You can only kill once."},
            {n:"King",t:"Townsfolk",d:"Each night, if the dead outnumber the living, you learn a living character.",f:true},
            {n:"Choirboy",t:"Townsfolk",d:"If the King dies, you learn the Demon."},
            {n:"High Priestess",t:"Townsfolk",d:"Each opening night, learn a player. They are good.",f:true},
            {n:"General",t:"Townsfolk",d:"Start knowing which team is winning.",f:true},
            {n:"Farmer",t:"Townsfolk",d:"If you die at night, an alive good player becomes a Farmer."},
            {n:"Magician",t:"Townsfolk",d:"The Demon thinks you are a Minion. Minions think you are a Minion.",f:true},
            {n:"Pixie",t:"Townsfolk",d:"Start knowing 1 in-play Townsfolk. If you were mad you were them, you gain their ability when they die.",f:true},
            {n:"Acrobat",t:"Townsfolk",d:"Each night*, if a neighbor is drunk or poisoned, you die."},
            {n:"Cult Leader",t:"Townsfolk",d:"Each night, choose a player: they join your cult. If all players are cult, you win."},
            {n:"Lycanthrope",t:"Townsfolk",d:"Each night*, choose a player: they die. Good players can only die this way."},
            {n:"Alchemist",t:"Townsfolk",d:"You have a Minion ability.",f:true},
            {n:"Knight",t:"Townsfolk",d:"You start knowing 2 players that are not the Demon.",f:true},
            {n:"Steward",t:"Townsfolk",d:"You start knowing 1 good player.",f:true},
            {n:"Village Idiot",t:"Townsfolk",d:"Each night, choose a player: you learn their alignment. +2 Village Idiots. One is drunk."},
            {n:"Puzzlemaster",t:"Outsider",d:"1 player is drunk, even if you die. If you guess who, you learn the Demon."},
            {n:"Plague Doctor",t:"Outsider",d:"If you die, the Storyteller gains a Minion ability."}
        ];
    </script>
</head>
<body>

    <div id="screen-splash" class="screen">
        <h1 class="hero-title">GRIMOIRE</h1>
        <div style="text-align:center; color:#888; margin-bottom:40px;">The Storyteller's Companion</div>
        
        <div class="splash-section">
            <div class="section-title">Official Scripts</div>
            <div class="script-grid">
                <div class="script-card card-official" onclick="openPreview('TB')">
                    <h3>Trouble Brewing</h3><p>Logic &bull; Deduction</p>
                </div>
                <div class="script-card card-official" onclick="openPreview('BM')">
                    <h3>Bad Moon Rising</h3><p>Death &bull; Gambling</p>
                </div>
                <div class="script-card card-official" onclick="openPreview('SV')">
                    <h3>Sects & Violets</h3><p>Madness &bull; Chaos</p>
                </div>
            </div>
        </div>

        <div class="splash-section">
            <div class="section-title">Homebrew Collection</div>
            <div class="script-grid" id="custom-grid">
                <div class="script-card card-new" onclick="openBuilder()">
                    <h3>+ Create New Script</h3>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-preview" class="modal-overlay hidden">
        <div class="edit-box" style="width:600px; height:80vh; display:flex; flex-direction:column;">
            <div style="border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:15px;">
                <h2 style="margin:0;" id="prev-title">Script Title</h2>
            </div>
            <div class="preview-content">
                <div class="preview-lists" id="prev-lists"></div>
            </div>
            <div style="border-top:1px solid #333; padding-top:15px; display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-red hidden" id="btn-prev-del" onclick="deleteCustomScript()">Delete</button>
                <button class="btn btn-outline hidden" id="btn-prev-edit" onclick="editCustomScript()">Edit</button>
                <button class="btn btn-outline" onclick="closePreview()">Cancel</button>
                <button class="btn" onclick="startScriptSetup()">Play Script &rarr;</button>
            </div>
        </div>
    </div>

    <div id="screen-builder" class="screen hidden">
        <div class="builder-header">
            <input type="text" class="title-input" id="build-title" placeholder="Script Title">
            <div>
                <button class="btn btn-outline" onclick="exitBuilder()">Cancel</button>
                <button class="btn" onclick="saveCustomScript()">Save Script</button>
            </div>
        </div>
        <div style="padding:0 10px 10px 10px;"><input type="text" id="build-search" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white;" placeholder="Search roles..." onkeyup="filterBuilder(this.value)"></div>
        <div class="builder-body">
            <div class="library-panel">
                <div class="lib-tabs">
                    <button class="lib-tab active" id="tab-TB" onclick="switchLibTab('Trouble Brewing', this)">TB</button>
                    <button class="lib-tab" id="tab-BM" onclick="switchLibTab('Bad Moon Rising', this)">BMR</button>
                    <button class="lib-tab" id="tab-SV" onclick="switchLibTab('Sects & Violets', this)">SV</button>
                    <button class="lib-tab" id="tab-Trav" onclick="switchLibTab('Traveler', this)">Trav</button>
                    <button class="lib-tab" id="tab-Fab" onclick="switchLibTab('Fabled', this)">Fab</button>
                    <button class="lib-tab" id="tab-Lor" onclick="switchLibTab('Loric', this)">Lor</button>
                    <button class="lib-tab" id="tab-Exp" onclick="switchLibTab('Experimental', this)">Exp</button>
                </div>
                <div class="library-list" id="build-lib"></div>
            </div>
            <div class="script-panel" style="grid-template-columns: repeat(7, 1fr);">
                <div class="script-col" id="b-town"><h4>Townsfolk</h4></div>
                <div class="script-col" id="b-out"><h4>Outsider</h4></div>
                <div class="script-col" id="b-min"><h4>Minion</h4></div>
                <div class="script-col" id="b-dem"><h4>Demon</h4></div>
                <div class="script-col" id="b-trav"><h4>Traveler</h4></div>
                <div class="script-col" id="b-fab"><h4>Fabled</h4></div>
                <div class="script-col" id="b-lor"><h4>Loric</h4></div>
            </div>
        </div>
    </div>

    <div id="screen-setup" class="screen setup-screen hidden">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap: 20px;">
                <div class="stepper"><button onclick="changeCount(-1)">‚àí</button><span id="p-count">5</span><button onclick="changeCount(1)">+</button></div>
                <div class="counts-display"><div class="count-pill" id="req-town">Town: 0/3</div><div class="count-pill" id="req-out">Out: 0/0</div><div class="count-pill" id="req-min">Min: 0/1</div><div class="count-pill" id="req-dem">Dem: 0/1</div></div>
            </div>
            <button class="btn" id="btn-next" disabled onclick="handleStep1Next()">Next &rarr;</button>
        </div>
        <div id="role-grid-1" class="grid-scroll-area"></div>
    </div>

    <div id="screen-setup-drunk" class="screen setup-screen hidden">
        <div class="top-bar"><h2>Select Drunk's Fake Role</h2><button class="btn" id="btn-drunk-confirm" disabled onclick="gotoSetupBluffs()">Confirm &rarr;</button></div><div id="role-grid-drunk" class="grid-scroll-area"></div>
    </div>
    <div id="screen-setup-bluffs" class="screen setup-screen hidden">
        <div class="top-bar"><h2>Select 3 Demon Bluffs <span id="bluff-counter" style="opacity:0.7;">0/3</span></h2><button class="btn" id="btn-enter" disabled onclick="enterGame()">Enter Town Square &rarr;</button></div><div id="role-grid-bluffs" class="grid-scroll-area"></div>
    </div>

    <div id="screen-game" class="screen hidden">
        <div id="sidebar">
            <h3 style="margin-top:0;">Controls</h3>
            <input type="text" id="input-name" placeholder="Enter Name..." onkeypress="if(event.key==='Enter') addPlayer()">
            <button class="btn" onclick="addPlayer()">+ Add Player</button>
            <hr style="border-color:var(--border); width:100%; margin: 20px 0;">
            <button class="btn" style="width:100%; background: #333; margin-bottom:10px;" onclick="randomizeRoles()">üé≤ Shuffle & Assign</button>
            <button class="btn btn-outline" style="width:100%; color:var(--dem-color); border-color:var(--dem-color);" onclick="showBluffsModal()">üëÅ Show Bluffs</button>
            <div style="margin-top: auto; display:flex; justify-content:space-between; align-items:center;"><span id="phase-disp" style="font-weight:bold; font-size:1.2rem;">Setup</span><button class="btn" onclick="nextPhase()">Next Phase</button></div>
            <div id="game-log" style="height:100px; background:#111; overflow-y:auto; margin-top:10px; font-size:0.8rem; padding:5px; color:#aaa; border:1px solid #333;"></div>
        </div>
        <div id="game-board">
            <div id="town-circle-guide"></div>
            <div class="fab-container">
                <div class="fab" id="fab-lock" onclick="toggleLock()"><span>üîí Locked</span></div>
                <div class="fab" title="Distribute Evenly" onclick="distributePlayers()"><span style="font-size:1.2rem;">‚Üª</span></div>
            </div>
        </div>
    </div>

    <div id="modal-card" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
        <div class="card-view" onclick="event.stopPropagation()">
            <img id="cv-img" class="card-img-lg" src="">
            <div class="card-title" id="cv-name">IMP</div>
            <div class="card-type" id="cv-type">DEMON</div>
            <div class="card-desc" id="cv-desc"></div>
            <div style="margin-top:auto; font-size:0.8rem; color:#888;">(Tap anywhere to close)</div>
        </div>
    </div>

    <div id="hover-tooltip" class="hover-card hidden">
        <div class="hover-head">
            <img id="ht-img" class="hover-img" src="">
            <div class="hover-info">
                <h3 id="ht-name">Role Name</h3>
                <span id="ht-type">Townsfolk</span>
            </div>
        </div>
        <div class="hover-desc" id="ht-desc">Description goes here...</div>
    </div>

    <div id="modal-edit" class="modal-overlay hidden">
        <div class="edit-box">
            <input type="text" id="edit-name-input" class="edit-header-input" placeholder="Player Name">
            <div class="role-changer-btn" onclick="openRolePicker()"><img id="edit-role-icon" class="role-changer-icon" src=""><span id="edit-role-text" class="role-changer-text">Role</span><span style="font-size:0.8rem; color:#888;">(Change)</span></div>
            <div class="toggle-row">
                <div id="toggle-life" class="toggle-container toggle-alive" onclick="toggleLifeSwitch()"><div class="toggle-slider"></div><div class="toggle-opt">Alive</div><div class="toggle-opt">Dead</div></div>
                <div id="toggle-align" class="toggle-container toggle-align" onclick="toggleAlignSwitch()"><div class="toggle-slider"></div><div class="toggle-opt">Good</div><div class="toggle-opt">Evil</div></div>
            </div>
            <label style="color:#888; font-size:0.8rem; display:block; margin-bottom:5px;">REMINDER TOKENS</label>
            <div class="reminder-grid">
                <button class="rem-btn" onclick="toggleRem(this, 'Is Demon')">Is Demon</button><button class="rem-btn" onclick="toggleRem(this, 'Safe')">Safe</button>
                <button class="rem-btn" onclick="toggleRem(this, 'Poisoned')">Poisoned</button><button class="rem-btn" onclick="toggleRem(this, 'Drunk')">Drunk</button>
                <button class="rem-btn" onclick="toggleRem(this, 'Mad')">Mad</button><button class="rem-btn" onclick="toggleRem(this, 'Dead Vote')">Dead Vote</button>
                <button class="rem-btn" style="grid-column: span 2; color:#ff8888;" onclick="clearRem()">Clear Tokens</button>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:20px;"><button class="btn" onclick="saveEditAndClose()">Done</button></div>
        </div>
    </div>

    <div id="modal-role-picker" class="modal-overlay hidden" style="z-index:10001">
        <div class="edit-box" style="width: 500px; max-width:95vw;">
            <h3 style="margin-top:0;">Select Role</h3>
            <div id="role-picker-grid" class="role-grid-full" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px,1fr)); gap:10px; max-height:70vh; overflow-y:auto;"></div>
            <button class="btn" style="width:100%; margin-top:10px; background:#444;" onclick="document.getElementById('modal-role-picker').classList.add('hidden')">Cancel</button>
        </div>
    </div>

    <div id="modal-bluffs" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
        <div style="text-align:center;"><h2 style="color:var(--dem-color);">DEMON BLUFFS</h2><div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;" id="bluff-cards-cont"></div></div>
    </div>

    <script>
        // --- ASSETS ---
        function cleanName(name) { return name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(); }
        function getIconUrl(roleName) {
            if(!roleName) return null;
            return `./icons/${cleanName(roleName)}.png`;
        }
        const getBadgeHtml = (name, type) => {
            let cClass = 'b-town'; 
            if(type==='Outsider') cClass='b-out'; 
            if(type==='Minion') cClass='b-min'; 
            if(type==='Demon') cClass='b-dem';
            if(type==='Traveler') cClass='b-trav';
            if(type==='Fabled') cClass='b-fab';
            if(type==='Loric') cClass='b-lor';
            return `<div class="badge-icon ${cClass}"><span>${name ? name.charAt(0) : '?'}</span></div>`;
        };
        const getColorByType = (type) => {
            if(type==='Townsfolk') return 'var(--town-color)';
            if(type==='Outsider') return 'var(--out-color)';
            if(type==='Minion') return 'var(--min-color)';
            if(type==='Demon') return 'var(--dem-color)';
            if(type==='Traveler') return 'var(--trav-color)';
            if(type==='Fabled') return 'var(--fab-color)';
            if(type==='Loric') return 'var(--lor-color)';
            return '#555';
        }

        // --- STATE & STORAGE ---
        let app = {
            activeScriptId: null, // 'TB', 'BM', 'SV' or Timestamp
            activeRoles: {}, // {Townsfolk:[],...}
            count: 5,
            sel: { Townsfolk:[], Outsider:[], Minion:[], Demon:[] },
            players: [], locked: true, phase: 0, setupDrunkRole: "", bluffs: [],
            editId: null, editTemp: {},
            libTab: "Trouble Brewing" // Default tab
        };
        const baseDist = { 5:[3,0,1,1], 6:[3,1,1,1], 7:[5,0,1,1], 8:[5,1,1,1], 9:[5,2,1,1], 10:[7,0,2,1], 11:[7,1,2,1], 12:[7,2,2,1], 13:[9,0,3,1], 14:[9,1,3,1], 15:[9,2,3,1] };

        // --- INIT & SPLASH ---
        window.onload = loadCustomScripts;

        function loadCustomScripts() {
            const grid = document.getElementById('custom-grid');
            // Remove existing custom cards (keep the "Create New" card)
            Array.from(grid.children).forEach(c => { if(!c.classList.contains('card-new')) c.remove(); });
            
            const saved = JSON.parse(localStorage.getItem('grimoire_scripts') || '[]');
            saved.forEach(s => {
                const card = document.createElement('div');
                card.className = 'script-card card-custom';
                card.innerHTML = `<h3>${s.title}</h3><p>Custom Script</p>`;
                card.onclick = () => openPreview(s.id);
                grid.insertBefore(card, grid.lastElementChild);
            });
            
            // Mouse tracking for tooltip
            document.addEventListener('mousemove', (e) => {
                const tt = document.getElementById('hover-tooltip');
                if(!tt.classList.contains('hidden')) {
                    // Position to bottom right of cursor
                    let top = e.clientY + 15;
                    let left = e.clientX + 15;
                    // Boundary checks
                    if(left + 320 > window.innerWidth) left = e.clientX - 320;
                    if(top + 150 > window.innerHeight) top = e.clientY - 150;
                    
                    tt.style.top = top + 'px';
                    tt.style.left = left + 'px';
                }
            });
        }

        // --- PREVIEW ---
        let previewScript = null;
        function openPreview(id) {
            let scriptData;
            // Official
            if(['TB','BM','SV'].includes(id)) {
                const names = {TB:"Trouble Brewing",BM:"Bad Moon Rising",SV:"Sects & Violets"};
                scriptData = { id: id, title: names[id], content: getOfficialContent(id), isOfficial: true };
            } else {
                // Custom (ID is number, stored as number in JSON, so we might need loose match or parseInt)
                const saved = JSON.parse(localStorage.getItem('grimoire_scripts') || '[]');
                scriptData = saved.find(s => s.id == id); // == for type coercion just in case
            }
            if(!scriptData) return;
            previewScript = scriptData;

            document.getElementById('prev-title').innerText = scriptData.title;
            const con = document.getElementById('prev-lists'); con.innerHTML = '';
            
            // Render all categories present
            ['Townsfolk','Outsider','Minion','Demon','Traveler','Fabled','Loric'].forEach(type => {
                if(!scriptData.content[type] || scriptData.content[type].length === 0) return;
                
                const col = document.createElement('div'); col.className='preview-col';
                col.innerHTML = `<h4>${type}</h4>`;
                scriptData.content[type].forEach(rName => {
                    const r = DB.find(x=>x.n===rName) || {n:rName};
                    const firstNight = r.f ? '<span style="color:gold; font-weight:bold;">*</span>' : '';
                    col.innerHTML += `<div class="preview-item"><img src="${getIconUrl(r.n)}" class="preview-icon"> ${r.n} ${firstNight}</div>`;
                });
                con.appendChild(col);
            });

            // Buttons
            document.getElementById('btn-prev-del').classList.toggle('hidden', !!scriptData.isOfficial);
            document.getElementById('btn-prev-edit').classList.toggle('hidden', !!scriptData.isOfficial);
            
            document.getElementById('screen-splash').classList.add('hidden');
            document.getElementById('modal-preview').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('modal-preview').classList.add('hidden');
            document.getElementById('screen-splash').classList.remove('hidden');
        }

        function getOfficialContent(id) {
            // Filter DB based on ID
            let list = [];
            if(id==='TB') list = ["Washerwoman","Librarian","Investigator","Chef","Empath","Fortune Teller","Undertaker","Monk","Ravenkeeper","Virgin","Slayer","Soldier","Mayor","Butler","Drunk","Recluse","Saint","Poisoner","Spy","Scarlet Woman","Baron","Imp"];
            if(id==='BM') list = ["Grandmother","Sailor","Chambermaid","Exorcist","Innkeeper","Gambler","Gossip","Courtier","Professor","Minstrel","Tea Lady","Pacifist","Fool","Tinker","Moonchild","Goon","Lunatic","Godfather","Devils Advocate","Assassin","Mastermind","Zombuul","Pukka","Shabaloth","Po"];
            if(id==='SV') list = ["Clockmaker","Dreamer","Snake Charmer","Mathematician","Flowergirl","Town Crier","Oracle","Savant","Seamstress","Philosopher","Artist","Juggler","Sage","Mutant","Sweetheart","Barber","Klutz","Witch","Cerebus","Pit-Hag","Evil Twin","Fang Gu","Vortox","No Dashii","Vigormortis"];
            
            const res = {Townsfolk:[], Outsider:[], Minion:[], Demon:[], Traveler:[], Fabled:[], Loric:[]};
            list.forEach(n => { const r = DB.find(x=>x.n===n); if(r) res[r.t].push(r.n); });
            return res;
        }

        function startScriptSetup() {
            app.activeScriptId = previewScript.id;
            app.activeRoles = previewScript.content;
            document.getElementById('modal-preview').classList.add('hidden');
            document.getElementById('screen-setup').classList.remove('hidden');
            renderStep1(); updateCalc();
        }

        // --- BUILDER ---
        let builderData = { Townsfolk:[], Outsider:[], Minion:[], Demon:[], Traveler:[], Fabled:[], Loric:[] };
        function openBuilder() {
            builderData = { Townsfolk:[], Outsider:[], Minion:[], Demon:[], Traveler:[], Fabled:[], Loric:[] };
            document.getElementById('build-title').value = "";
            document.getElementById('screen-splash').classList.add('hidden');
            document.getElementById('screen-builder').classList.remove('hidden');
            renderLibrary(''); renderBuilderCols();
        }
        function exitBuilder() { document.getElementById('screen-builder').classList.add('hidden'); document.getElementById('screen-splash').classList.remove('hidden'); }
        
        // Tab switching logic
        function switchLibTab(name, el) {
            app.libTab = name;
            document.querySelectorAll('.lib-tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            // Re-render
            const filter = document.getElementById('build-search').value;
            renderLibrary(filter);
        }

        function renderLibrary(filter) {
            const container = document.getElementById('build-lib');
            container.innerHTML = '';
            const f = filter.toLowerCase();

            // Official Lists
            const tbRoles = getOfficialContent('TB');
            const bmRoles = getOfficialContent('BM');
            const svRoles = getOfficialContent('SV');
            
            // Define Sources
            const sources = [
                { name: "Trouble Brewing", roles: tbRoles },
                { name: "Bad Moon Rising", roles: bmRoles },
                { name: "Sects & Violets", roles: svRoles },
                { name: "Traveler", roles: getRolesByType('Traveler') },
                { name: "Fabled", roles: getRolesByType('Fabled') },
                { name: "Loric", roles: getRolesByType('Loric') },
                { name: "Experimental", roles: getExperimentalRoles() }
            ];

            // Filter by Active Tab
            const activeSource = sources.find(s => s.name === app.libTab);
            
            if (activeSource) {
                const section = document.createElement('div');
                section.className = 'lib-section';
                
                ['Townsfolk', 'Outsider', 'Minion', 'Demon', 'Traveler', 'Fabled', 'Loric'].forEach(t => {
                    let roleNames = activeSource.roles[t] || []; 
                    roleNames = roleNames.filter(n => n.toLowerCase().includes(f));
                    
                    if (roleNames.length > 0) {
                        const subHead = document.createElement('div');
                        subHead.className = 'lib-type-header';
                        subHead.innerText = t;
                        section.appendChild(subHead);

                        roleNames.forEach(rName => {
                            const r = DB.find(x => x.n === rName) || {n:rName, t:t};
                            const el = document.createElement('div');
                            const isAdded = builderData[r.t] && builderData[r.t].includes(r.n);
                            el.className = `build-item ${isAdded ? 'added' : ''}`;
                            el.innerHTML = `
                                <div class="build-left">
                                    <img src="${getIconUrl(r.n)}" style="width:20px;height:20px;">
                                    <span>${r.n}</span>
                                </div>
                                <div class="build-eye" onclick="showCard(event, '${r.n}', '${r.t}')" onmouseenter="showHover(event, '${r.n}', '${r.t}')" onmouseleave="hideHover()">üëÅ</div>
                            `;
                            // Toggle Action
                            el.querySelector('.build-left').onclick = () => { toggleBuilderRole(r); renderLibrary(filter); renderBuilderCols(); };
                            section.appendChild(el);
                        });
                    }
                });
                container.appendChild(section);
            }
        }

        function getExperimentalRoles() {
            // All roles NOT in the official 3 AND not in Trav/Fab/Lor categories
            const officials = [
                ...getOfficialContent('TB').Townsfolk, ...getOfficialContent('TB').Outsider, ...getOfficialContent('TB').Minion, ...getOfficialContent('TB').Demon,
                ...getOfficialContent('BM').Townsfolk, ...getOfficialContent('BM').Outsider, ...getOfficialContent('BM').Minion, ...getOfficialContent('BM').Demon,
                ...getOfficialContent('SV').Townsfolk, ...getOfficialContent('SV').Outsider, ...getOfficialContent('SV').Minion, ...getOfficialContent('SV').Demon
            ];
            const exp = { Townsfolk:[], Outsider:[], Minion:[], Demon:[], Traveler:[], Fabled:[], Loric:[] };
            DB.forEach(r => {
                // If it's a base type and not in official lists, it's Experimental
                if(['Townsfolk','Outsider','Minion','Demon'].includes(r.t) && !officials.includes(r.n)) {
                    exp[r.t].push(r.n);
                }
            });
            return exp;
        }

        function getRolesByType(targetType) {
            const res = { Townsfolk:[], Outsider:[], Minion:[], Demon:[], Traveler:[], Fabled:[], Loric:[] };
            DB.forEach(r => {
                if(r.t === targetType) res[targetType].push(r.n);
            });
            return res;
        }

        function toggleBuilderRole(r) {
            const idx = builderData[r.t].indexOf(r.n);
            if(idx > -1) builderData[r.t].splice(idx, 1);
            else builderData[r.t].push(r.n);
        }
        
        function renderBuilderCols() {
            const map = {Townsfolk:'b-town', Outsider:'b-out', Minion:'b-min', Demon:'b-dem', Traveler:'b-trav', Fabled:'b-fab', Loric:'b-lor'};
            ['Townsfolk','Outsider','Minion','Demon','Traveler','Fabled','Loric'].forEach(t => {
                const col = document.getElementById(map[t]);
                // Clear but keep header
                col.innerHTML = `<h4>${t}</h4>` + builderData[t].map(n=>`<div>${n}</div>`).join('');
            });
        }
        
        function saveCustomScript() {
            const title = document.getElementById('build-title').value.trim();
            if(!title) return alert("Title required.");
            const scripts = JSON.parse(localStorage.getItem('grimoire_scripts') || '[]');
            
            // If editing, remove old
            if(previewScript && !previewScript.isOfficial) {
                const idx = scripts.findIndex(s=>s.id===previewScript.id);
                if(idx>-1) scripts.splice(idx,1);
            }

            const newScript = { id: Date.now(), title: title, content: builderData };
            scripts.push(newScript);
            localStorage.setItem('grimoire_scripts', JSON.stringify(scripts));
            exitBuilder(); loadCustomScripts();
        }
        function deleteCustomScript() {
            if(!confirm("Delete this script?")) return;
            const scripts = JSON.parse(localStorage.getItem('grimoire_scripts') || '[]');
            const idx = scripts.findIndex(s=>s.id===previewScript.id);
            if(idx>-1) scripts.splice(idx,1);
            localStorage.setItem('grimoire_scripts', JSON.stringify(scripts));
            document.getElementById('modal-preview').classList.add('hidden');
            document.getElementById('screen-splash').classList.remove('hidden');
            loadCustomScripts();
        }
        function editCustomScript() {
            builderData = JSON.parse(JSON.stringify(previewScript.content)); // Clone
            // Ensure all keys exist
            ['Townsfolk','Outsider','Minion','Demon','Traveler','Fabled','Loric'].forEach(k => {
                if(!builderData[k]) builderData[k] = [];
            });

            document.getElementById('build-title').value = previewScript.title;
            document.getElementById('modal-preview').classList.add('hidden');
            document.getElementById('screen-builder').classList.remove('hidden');
            renderLibrary(''); renderBuilderCols();
        }

        // --- SETUP STEP 1 ---
        function changeCount(d) { let n = app.count + d; if(n<5) n=5; if(n>15) n=15; app.count = n; document.getElementById('p-count').innerText = n; updateCalc(); }
        function renderStep1() {
            const con = document.getElementById('role-grid-1'); con.innerHTML = '';
            for(let type in app.activeRoles) {
                if(app.activeRoles[type].length === 0) continue;
                const col = document.createElement('div'); col.className = 'role-col'; col.innerHTML = `<h3>${type}</h3>`;
                app.activeRoles[type].forEach(rName => {
                    const rData = DB.find(x=>x.n===rName) || {n:rName, mod:null};
                    const el = createRoleItem(rData, type, false);
                    el.onclick = (e) => { if(!e.target.classList.contains('eye-btn')) toggleRoleStep1(type, rName, el); };
                    col.appendChild(el);
                });
                con.appendChild(col);
            }
        }
        function toggleRoleStep1(type, name, el) {
            if(!app.sel[type]) app.sel[type] = []; // Safety init
            const list = app.sel[type]; const i = list.indexOf(name);
            if(i > -1) { list.splice(i, 1); el.classList.remove('selected'); } else { list.push(name); el.classList.add('selected'); }
            updateCalc();
        }
        function updateCalc() {
            let req = [...(baseDist[app.count] || [3,0,1,1])];
            if(app.sel.Minion && app.sel.Minion.includes("Baron")) { req[0]-=2; req[1]+=2; }
            if(app.sel.Minion && app.sel.Minion.includes("Godfather")) { req[0]-=1; req[1]+=1; }
            if(app.sel.Demon && app.sel.Demon.includes("Fang Gu")) { req[0]-=1; req[1]+=1; }
            if(app.sel.Townsfolk && app.sel.Townsfolk.includes("Balloonist")) { req[0]-=1; req[1]+=1; }
            
            const cTown = app.sel.Townsfolk ? app.sel.Townsfolk.length : 0;
            const cOut = app.sel.Outsider ? app.sel.Outsider.length : 0;
            const cMin = app.sel.Minion ? app.sel.Minion.length : 0;
            const cDem = app.sel.Demon ? app.sel.Demon.length : 0;

            checkCat('req-town', cTown, req[0]); 
            checkCat('req-out', cOut, req[1]); 
            checkCat('req-min', cMin, req[2]); 
            checkCat('req-dem', cDem, req[3]);
            
            document.getElementById('btn-next').disabled = !(cTown===req[0] && cOut===req[1] && cMin===req[2] && cDem===req[3]);
        }
        function checkCat(id, cur, req) { const el = document.getElementById(id); el.innerText = `${id.split('-')[1].toUpperCase()}: ${cur}/${req}`; if(cur===req){el.classList.add('valid');el.classList.remove('invalid')}else{el.classList.add('invalid');el.classList.remove('valid')} }
        function handleStep1Next() { if(app.sel.Outsider.includes("Drunk")) gotoDrunkSetup(); else gotoSetupBluffs(); }

        // --- STEP 2/3 ---
        function gotoDrunkSetup() {
            document.getElementById('screen-setup').classList.add('hidden'); document.getElementById('screen-setup-drunk').classList.remove('hidden');
            const con = document.getElementById('role-grid-drunk'); con.innerHTML = '';
            const allSel = []; ['Townsfolk','Outsider','Minion','Demon'].forEach(t => { if(app.sel[t]) allSel.push(...app.sel[t]); });
            
            if(app.activeRoles.Townsfolk) {
                app.activeRoles.Townsfolk.forEach(rName => {
                    const r = DB.find(x=>x.n===rName);
                    const el = createRoleItem(r, 'Townsfolk', false);
                    if(allSel.includes(r.n)) { el.classList.add('in-play'); el.querySelector('span').innerText += " (In Play)"; }
                    el.onclick = (e) => { if(e.target.classList.contains('eye-btn')) return; document.querySelectorAll('#role-grid-drunk .selected').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); app.setupDrunkRole=r.n; document.getElementById('btn-drunk-confirm').disabled=false; };
                    con.appendChild(el);
                });
            }
        }
        function gotoSetupBluffs() {
            document.getElementById('screen-setup').classList.add('hidden'); document.getElementById('screen-setup-drunk').classList.add('hidden'); document.getElementById('screen-setup-bluffs').classList.remove('hidden');
            const con = document.getElementById('role-grid-bluffs'); con.innerHTML = '';
            const allSel = []; ['Townsfolk','Outsider','Minion','Demon'].forEach(t => { if(app.sel[t]) allSel.push(...app.sel[t]); });
            
            for(let type in app.activeRoles) {
                // Bluffs usually only T/O/M/D, skipping Trav/Fab/Lor
                if(['Traveler','Fabled','Loric'].includes(type)) continue;
                
                app.activeRoles[type].forEach(rName => {
                    const r = DB.find(x=>x.n===rName);
                    const inPlay = allSel.includes(r.n);
                    const el = createRoleItem(r, type, inPlay);
                    if(inPlay) el.classList.add('disabled');
                    el.onclick = (e) => { if(!e.target.classList.contains('eye-btn') && !inPlay) toggleBluff(r.n, el); };
                    con.appendChild(el);
                });
            }
        }
        function toggleBluff(name, el) {
            const i = app.bluffs.indexOf(name);
            if(i > -1) { app.bluffs.splice(i, 1); el.classList.remove('selected'); } else { if(app.bluffs.length >= 3) return; app.bluffs.push(name); el.classList.add('selected'); }
            document.getElementById('bluff-counter').innerText = `${app.bluffs.length}/3`;
            document.getElementById('btn-enter').disabled = (app.bluffs.length !== 3);
        }
        function createRoleItem(r, type, disabled) {
            const el = document.createElement('div'); el.className = 'role-item';
            const url = getIconUrl(r.n); const modHtml = r.mod ? `<span class="mod-text">[${r.mod}]</span>` : '';
            el.innerHTML = `<div class="role-left"><img src="${url}" class="setup-icon" onerror="this.style.opacity=0.3"><span style="${disabled?'text-decoration:line-through':''}">${r.n}${modHtml}</span></div><div class="eye-btn" onclick="showCard(event, '${r.n}', '${type}')" onmouseenter="showHover(event, '${r.n}', '${type}')" onmouseleave="hideHover()">üëÅ</div>`;
            return el;
        }
        function enterGame() { document.getElementById('screen-setup-bluffs').classList.add('hidden'); document.getElementById('screen-game').classList.remove('hidden'); log("Welcome to Ravenswood Bluff."); }

        // --- GAMEPLAY ---
        let drag=null, offX=0, offY=0;
        function addPlayer() {
            const n = document.getElementById('input-name').value.trim(); if(!n) return;
            const p = { id:Date.now(), name:n, role:"", fake:"", align:"good", dead:false, reminders:[], x:0, y:0 };
            app.players.push(p);
            const el = document.createElement('div'); el.id = `token-${p.id}`; el.className = 'token good draggable';
            el.innerHTML = `<div class="token-reminders"></div><div class="token-icon-wrap"><img class="token-img" src="" style="display:none">${getBadgeHtml('?', 'Townsfolk')}</div><div class="token-name">${n}</div><div class="token-ctrl ctrl-eye" onmousedown="viewPlayerCard(event, ${p.id})" onmouseenter="showHover(event, getPlayerRoleName(${p.id}), getPlayerRoleType(${p.id}))" onmouseleave="hideHover()">üëÅ</div><div class="token-ctrl ctrl-del" onmousedown="delPlayer(event, ${p.id})">‚úï</div><div class="token-ctrl ctrl-vote" onmousedown="toggleVote(event, ${p.id})"></div>`;
            const board = document.getElementById('game-board'); p.x = board.offsetWidth/2 - 55; p.y = board.offsetHeight/2 - 55; el.style.left = p.x+'px'; el.style.top = p.y+'px';
            el.onmousedown = (e) => startDrag(e, el, p); el.onclick = (e) => { if(!e.target.classList.contains('token-ctrl') && !e.target.classList.contains('ctrl-vote')) { if(app.locked) openEdit(p.id); } };
            board.appendChild(el); document.getElementById('input-name').value = ''; updateToken(p);
        }
        function getPlayerRoleName(id) { const p = app.players.find(x=>x.id===id); if(!p) return null; return (p.role==="Drunk" && p.fake) ? p.fake : p.role; }
        function getPlayerRoleType(id) { const n = getPlayerRoleName(id); if(!n) return 'Townsfolk'; return getRoleType(n); }
        
        function randomizeRoles() {
            let pool = []; ['Townsfolk','Outsider','Minion','Demon'].forEach(t => { if(app.sel[t]) pool.push(...app.sel[t]); });
            for(let i=pool.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
            app.players.forEach((p, i) => { if(pool[i]) { p.role = pool[i]; p.fake = (p.role === "Drunk") ? app.setupDrunkRole : ""; if(p.role==="Drunk"&&!p.reminders.includes("Drunk"))p.reminders.push("Drunk"); const type = getRoleType(p.role); p.align = (type==='Minion'||type==='Demon') ? 'evil' : 'good'; updateToken(p); } });
        }
        function updateToken(p) {
            const el = document.getElementById(`token-${p.id}`);
            el.className = `token ${p.align} ${p.dead?'dead':''} ${!app.locked?'draggable':''}`;
            el.querySelector('.token-name').innerText = p.name;
            const rShow = (p.role === "Drunk" && p.fake) ? p.fake : p.role;
            const type = getRoleType(rShow) || 'Townsfolk';
            const img = el.querySelector('.token-img'); const badge = el.querySelector('.badge-icon');
            if(rShow) { img.src = getIconUrl(rShow); img.style.display='block'; img.onerror = () => { img.style.display='none'; badge.style.display='flex'; }; badge.innerHTML = `<span>${rShow.charAt(0)}</span>`; badge.className = `badge-icon ${type==='Demon'?'b-dem':type==='Minion'?'b-min':type==='Outsider'?'b-out':'b-town'}`; 
                // Color override for Badge
                const col = getColorByType(type);
                // Badge color classes handle gradients, but we set classes above in getBadgeHtml
            } else { img.style.display='none'; badge.style.display='none'; }
            const v = el.querySelector('.ctrl-vote'); if(p.dead) v.style.display='block'; else { v.style.display='none'; v.classList.remove('used'); }
            el.querySelector('.token-reminders').innerHTML = p.reminders.map(r => `<div class="reminder-tag">${r}</div>`).join('');
            
            // Re-bind hover event with new role data
            const eye = el.querySelector('.ctrl-eye');
            eye.onmouseenter = (e) => showHover(e, rShow, type);
            eye.onmouseleave = () => hideHover();
        }
        function startDrag(e, el, p) { if(app.locked || e.target.classList.contains('token-ctrl')) return; drag = el; const r = el.getBoundingClientRect(); offX = e.clientX - r.left; offY = e.clientY - r.top; document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag); }
        function onDrag(e) { if(!drag) return; const b = document.getElementById('game-board').getBoundingClientRect(); drag.style.left = (e.clientX - b.left - offX) + 'px'; drag.style.top = (e.clientY - b.top - offY) + 'px'; }
        function stopDrag() { drag=null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }
        function toggleLock() { app.locked = !app.locked; const btn = document.getElementById('fab-lock'); const body = document.body; if(app.locked) { btn.innerHTML = '<span>üîí Locked</span>'; btn.classList.remove('editing'); body.classList.remove('edit-mode'); } else { btn.innerHTML = '<span>üîì Edit Mode</span>'; btn.classList.add('editing'); body.classList.add('edit-mode'); } app.players.forEach(p => updateToken(p)); }
        function toggleVote(e, id) { e.stopPropagation(); document.getElementById(`token-${id}`).querySelector('.ctrl-vote').classList.toggle('used'); }
        function delPlayer(e, id) { e.stopPropagation(); if(confirm("Remove?")) { app.players = app.players.filter(x=>x.id!==id); document.getElementById(`token-${id}`).remove(); } }
        function viewPlayerCard(e, id) { e.stopPropagation(); const p = app.players.find(x=>x.id===id); const roleName = (p.role === "Drunk" && p.fake) ? p.fake : p.role; if(!roleName) return; showCard(null, roleName, getRoleType(roleName)); }
        function openEdit(id) { app.editId = id; const p = app.players.find(x=>x.id===id); app.editTemp = { ...p, reminders: [...p.reminders] }; document.getElementById('edit-name-input').value = p.name; document.getElementById('edit-role-text').innerText = p.role || "Select Role"; const icon = document.getElementById('edit-role-icon'); if(p.role) { icon.src = getIconUrl(p.role); icon.style.display='block'; } else { icon.style.display='none'; } const lTog = document.getElementById('toggle-life'); if(p.dead) lTog.classList.add('dead-state'); else lTog.classList.remove('dead-state'); const aTog = document.getElementById('toggle-align'); if(p.align==='evil') aTog.classList.add('evil-state'); else aTog.classList.remove('evil-state'); document.querySelectorAll('.rem-btn').forEach(btn => { if(p.reminders.includes(btn.innerText)) btn.classList.add('selected'); else btn.classList.remove('selected'); }); document.getElementById('modal-edit').classList.remove('hidden'); }
        function toggleLifeSwitch() { app.editTemp.dead = !app.editTemp.dead; document.getElementById('toggle-life').classList.toggle('dead-state'); }
        function toggleAlignSwitch() { app.editTemp.align = (app.editTemp.align === 'good') ? 'evil' : 'good'; document.getElementById('toggle-align').classList.toggle('evil-state'); }
        function toggleRem(btn, txt) { const idx = app.editTemp.reminders.indexOf(txt); if(idx > -1) { app.editTemp.reminders.splice(idx,1); btn.classList.remove('selected'); } else { app.editTemp.reminders.push(txt); btn.classList.add('selected'); } }
        function saveEditAndClose() { const p = app.players.find(x=>x.id===app.editId); p.name = document.getElementById('edit-name-input').value; p.role = app.editTemp.role; p.align = app.editTemp.align; p.dead = app.editTemp.dead; p.reminders = app.editTemp.reminders; updateToken(p); document.getElementById('modal-edit').classList.add('hidden'); }
        function openRolePicker() { const grid = document.getElementById('role-picker-grid'); grid.innerHTML = ''; const allRoles = []; ['Townsfolk','Outsider','Minion','Demon'].forEach(t => { if(app.activeRoles[t]) allRoles.push(...app.activeRoles[t]); }); allRoles.forEach(r => { const item = document.createElement('div'); item.className = 'picker-item'; if(app.editTemp.role === r) item.classList.add('active'); item.innerHTML = `<img src="${getIconUrl(r)}" class="picker-icon"><span class="picker-name">${r}</span>`; item.onclick = () => { app.editTemp.role = r; document.getElementById('edit-role-text').innerText = r; document.getElementById('edit-role-icon').src = getIconUrl(r); document.getElementById('edit-role-icon').style.display = 'block'; document.getElementById('modal-role-picker').classList.add('hidden'); }; grid.appendChild(item); }); document.getElementById('modal-role-picker').classList.remove('hidden'); }
        function distributePlayers() { if(app.players.length === 0) return; const b = document.getElementById('game-board').getBoundingClientRect(); const cx = b.width/2; const cy = b.height/2; const r = 250; app.players.forEach((p, i) => { const a = (i/app.players.length)*2*Math.PI-(Math.PI/2); p.x = cx+r*Math.cos(a)-55; p.y = cy+r*Math.sin(a)-55; const el=document.getElementById(`token-${p.id}`); el.style.left=p.x+'px'; el.style.top=p.y+'px'; }); }
        
        function showCard(e, name, type) { 
            if(e) e.stopPropagation(); 
            const d = DB.find(x=>x.n===name) || {d:"..."}; 
            document.getElementById('cv-name').innerText = name; 
            document.getElementById('cv-type').innerText = type; 
            document.getElementById('cv-desc').innerText = d.d; 
            const img = document.getElementById('cv-img'); 
            img.src = getIconUrl(name); 
            img.style.display = 'block'; 
            img.onerror = () => { img.style.display = 'none'; }; 
            
            // Set Color Style
            const col = getColorByType(type);
            document.querySelector('.card-view').style.borderColor = col;
            document.getElementById('cv-type').style.color = col;

            document.getElementById('modal-card').classList.remove('hidden'); 
        }

        // --- NEW HOVER LOGIC ---
        function showHover(e, name, type) {
            if(!name) return;
            const tt = document.getElementById('hover-tooltip');
            const d = DB.find(x=>x.n===name) || {d:"..."};
            
            document.getElementById('ht-name').innerText = name;
            document.getElementById('ht-type').innerText = type;
            document.getElementById('ht-desc').innerText = d.d;
            
            const img = document.getElementById('ht-img');
            img.src = getIconUrl(name);
            
            // Color Coding
            const col = getColorByType(type);
            tt.style.borderColor = col;
            document.getElementById('ht-type').style.color = col;
            document.getElementById('ht-name').style.color = col;

            // Initial Position
            tt.classList.remove('hidden');
        }

        function hideHover() {
            document.getElementById('hover-tooltip').classList.add('hidden');
        }

        function showBluffsModal() { if(!app.bluffs || app.bluffs.length === 0) return alert("No Bluffs."); const cont = document.getElementById('bluff-cards-cont'); cont.innerHTML = ''; app.bluffs.forEach(b => { const type = getRoleType(b); const d = DB.find(x=>x.n===b); const card = document.createElement('div'); card.className = 'mini-card'; card.innerHTML = `<img src="${getIconUrl(b)}" style="width:60px; height:60px; object-fit:contain; margin-bottom:10px;"><div style="font-weight:900; text-transform:uppercase;">${b}</div><div style="font-size:0.8rem; margin:5px 0 10px; color:#555;">${type}</div><div style="font-size:0.9rem; font-style:italic;">${d?d.d:''}</div>`; cont.appendChild(card); }); document.getElementById('modal-bluffs').classList.remove('hidden'); }
        function getRoleType(n) { const r = DB.find(x => x.n === n); return r ? r.t : 'Townsfolk'; }
        function log(t) { const d=document.createElement('div'); d.innerText=t; d.style.borderBottom="1px solid #222"; document.getElementById('game-log').prepend(d); }
        function nextPhase() { app.phase++; const t = (app.phase%2!==0)?`Night ${Math.ceil(app.phase/2)}`:`Day ${Math.ceil(app.phase/2)}`; document.getElementById('phase-disp').innerText = t; }
        
        function filterBuilder(val) { renderLibrary(val); }
    </script>
</body>
</html>
