<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimoire Companion - v4</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-blue: #2196f3;
            --accent-green: #4caf50;
            --accent-red: #f44336;
            --border: #333;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            background: var(--accent-blue);
            color: white;
            transition: 0.2s;
        }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; }
        .btn:hover:not(:disabled) { filter: brightness(1.1); }
        .btn-red { background: var(--accent-red); }

        /* --- SCREEN 1: SPLASH --- */
        #screen-splash {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .script-grid { display: flex; gap: 20px; margin-top: 30px; }
        .script-card {
            background: #222;
            border: 2px solid #444;
            padding: 20px;
            width: 200px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        .script-card:hover { border-color: var(--accent-blue); background: #2a2a2a; }

        /* --- SCREEN 2: SETUP --- */
        #screen-setup {
            position: fixed;
            inset: 0;
            background: var(--bg-color);
            z-index: 40;
            display: flex;
            flex-direction: column;
            padding: 20px;
            align-items: center;
        }
        
        .setup-header { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; }
        .counter-box {
            background: #222;
            padding: 10px 20px;
            border-radius: 4px;
            border: 1px solid #444;
            display: flex;
            gap: 15px;
        }
        .count-item { font-weight: bold; }
        .count-item span { color: #888; font-size: 0.9em; margin-left: 5px; }
        .count-item.valid { color: var(--accent-green); }
        .count-item.invalid { color: var(--accent-red); }

        #role-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 1000px;
            overflow-y: auto;
            flex-grow: 1;
            padding-bottom: 20px;
        }
        
        .role-col h3 { text-align: center; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        .role-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #aaa;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
        }
        .role-btn:hover { background: #333; }
        .role-btn.selected {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* --- SCREEN 3: GAME BOARD --- */
        #screen-game {
            display: flex;
            height: 100%;
            width: 100%;
        }

        #sidebar {
            width: 300px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 20;
        }

        #game-area {
            flex-grow: 1;
            position: relative;
            background: #181818;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* The visual circle */
        #town-circle {
            width: 600px;
            height: 600px;
            border: 4px dashed #333;
            border-radius: 50%;
            position: absolute;
            pointer-events: none; /* Let clicks pass through to tokens */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .player-token {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: #333;
            border: 3px solid #777;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            text-align: center;
        }
        .player-token:active { cursor: grabbing; z-index: 100; }
        .player-token.good { background: #1b3a1e; border-color: var(--accent-green); }
        .player-token.evil { background: #3e1b1b; border-color: var(--accent-red); }
        .player-token.dead { filter: grayscale(100%); border-style: dotted; opacity: 0.8; }

        .token-name { font-weight: bold; font-size: 0.85rem; pointer-events: none; }
        .token-role { font-size: 0.7rem; opacity: 0.9; pointer-events: none; margin-top:2px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        
        .ghost-vote {
            width: 20px; height: 20px; background: white; border-radius: 50%;
            position: absolute; bottom: -5px; border: 2px solid #333; cursor: pointer;
        }
        .ghost-vote.used { background: #555; border-color: #888; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-box { background: var(--panel-bg); padding: 20px; border-radius: 8px; width: 300px; }
        select, input { width: 100%; padding: 8px; margin-bottom: 10px; background: #333; border: 1px solid #555; color: white; }

    </style>
</head>
<body>

    <div id="screen-splash">
        <h1>Blood on the Clocktower</h1>
        <p>Unofficial Grimoire Companion</p>
        <div class="script-grid">
            <div class="script-card" onclick="loadSetup('TB')">
                <h3>Trouble Brewing</h3>
                <small>Beginner Friendly</small>
            </div>
            <div class="script-card" onclick="loadSetup('BM')">
                <h3>Bad Moon Rising</h3>
                <small>Death & Gambling</small>
            </div>
            <div class="script-card" onclick="loadSetup('SV')">
                <h3>Sects & Violets</h3>
                <small>Madness & Info</small>
            </div>
        </div>
    </div>

    <div id="screen-setup" class="hidden">
        <div class="setup-header">
            <h2>Game Setup</h2>
            <div>
                <label>Player Count:</label>
                <input type="number" id="playerCountInput" value="5" min="5" max="15" style="width: 60px;" onchange="updateRequirements()">
            </div>
            <div class="counter-box">
                <div class="count-item" id="req-town">Town: 0/3</div>
                <div class="count-item" id="req-out">Out: 0/0</div>
                <div class="count-item" id="req-min">Min: 0/1</div>
                <div class="count-item" id="req-dem">Dem: 0/1</div>
            </div>
            <button id="btn-start-game" class="btn" onclick="enterGame()" disabled>Enter Town Square</button>
        </div>
        <p style="font-size: 0.9rem; color: #888; margin-top: -15px;">Select the roles that will be in the bag.</p>

        <div id="role-grid">
            </div>
    </div>

    <div id="screen-game" class="hidden">
        <div id="sidebar">
            <h3>Grimoire</h3>
            <input type="text" id="newPlayerName" placeholder="Player Name" onkeypress="if(event.key==='Enter') addPlayer()">
            <button class="btn" onclick="addPlayer()">+ Add Player</button>
            <hr style="border-color: #333; width: 100%;">
            
            <div id="phase-display" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">Setup Phase</div>
            <button class="btn" onclick="nextPhase()">Next Phase</button>
            
            <div id="game-log" style="margin-top: 15px; flex-grow: 1; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #aaa; border-top: 1px solid #333; padding-top: 10px;">
                <div>Welcome to Ravenswood Bluff.</div>
            </div>
        </div>

        <div id="game-area">
            <div id="town-circle"></div>
            </div>
    </div>

    <div id="modal-edit" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>Edit Player</h3>
            <label>Role</label>
            <select id="edit-role"></select>
            <label>Alignment</label>
            <select id="edit-align">
                <option value="good">Good</option>
                <option value="evil">Evil</option>
            </select>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="saveEdit()">Save</button>
                <button class="btn btn-red" id="btn-kill" onclick="toggleLife()">Kill</button>
                <button class="btn" style="background:#555" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const scripts = {
            TB: {
                Townsfolk: ["Washerwoman", "Librarian", "Investigator", "Chef", "Empath", "Fortune Teller", "Undertaker", "Monk", "Ravenkeeper", "Virgin", "Slayer", "Soldier", "Mayor"],
                Outsider: ["Butler", "Drunk", "Recluse", "Saint"],
                Minion: ["Poisoner", "Spy", "Scarlet Woman", "Baron"],
                Demon: ["Imp"]
            },
            BM: {
                Townsfolk: ["Grandmother", "Sailor", "Chambermaid", "Exorcist", "Innkeeper", "Gambler", "Gossip", "Courtier", "Professor", "Minstrel", "Tea Lady", "Pacifist", "Fool"],
                Outsider: ["Tinker", "Moonchild", "Goon", "Lunatic"],
                Minion: ["Godfather", "Devil's Advocate", "Assassin", "Mastermind"],
                Demon: ["Zombuul", "Pukka", "Shabaloth", "Po"]
            },
            SV: {
                Townsfolk: ["Clockmaker", "Dreamer", "Snake Charmer", "Mathematician", "Flowergirl", "Town Crier", "Oracle", "Savant", "Seamstress", "Philosopher", "Artist", "Juggler", "Sage"],
                Outsider: ["Mutant", "Sweetheart", "Barber", "Klutz"],
                Minion: ["Witch", "Cerebus", "Pit-Hag", "Evil Twin"],
                Demon: ["Fang Gu", "Vortox", "No Dashii", "Vigormortis"]
            }
        };

        const distTable = {
            5: [3, 0, 1, 1], 6: [3, 1, 1, 1], 
            7: [5, 0, 1, 1], 8: [5, 1, 1, 1], 9: [5, 2, 1, 1], 
            10: [7, 0, 2, 1], 11: [7, 1, 2, 1], 12: [7, 2, 2, 1],
            13: [9, 0, 3, 1], 14: [9, 1, 3, 1], 15: [9, 2, 3, 1]
        };

        // --- STATE ---
        let currentScriptKey = 'TB';
        let selectedRoles = { Townsfolk: [], Outsider: [], Minion: [], Demon: [] };
        let players = [];
        let editingId = null;
        let phase = 0;
        let pIdCounter = 0;

        // --- STEP 1: LOAD SETUP ---
        function loadSetup(key) {
            currentScriptKey = key;
            document.getElementById('screen-splash').classList.add('hidden');
            document.getElementById('screen-setup').classList.remove('hidden');
            renderRoleGrid();
            updateRequirements();
        }

        function renderRoleGrid() {
            const grid = document.getElementById('role-grid');
            grid.innerHTML = '';
            const script = scripts[currentScriptKey];
            
            ['Townsfolk', 'Outsider', 'Minion', 'Demon'].forEach(type => {
                const col = document.createElement('div');
                col.className = 'role-col';
                col.innerHTML = `<h3>${type}</h3>`;
                
                script[type].forEach(role => {
                    const btn = document.createElement('div');
                    btn.className = 'role-btn';
                    btn.innerText = role;
                    btn.onclick = () => toggleRole(type, role, btn);
                    col.appendChild(btn);
                });
                grid.appendChild(col);
            });
        }

        function toggleRole(type, role, btn) {
            const list = selectedRoles[type];
            const idx = list.indexOf(role);
            if(idx > -1) {
                list.splice(idx, 1);
                btn.classList.remove('selected');
            } else {
                list.push(role);
                btn.classList.add('selected');
            }
            updateRequirements();
        }

        function updateRequirements() {
            const num = parseInt(document.getElementById('playerCountInput').value) || 5;
            const dist = distTable[num] || [3,0,1,1];
            
            // Validate
            const t = selectedRoles.Townsfolk.length;
            const o = selectedRoles.Outsider.length;
            const m = selectedRoles.Minion.length;
            const d = selectedRoles.Demon.length;

            updateCountUI('req-town', 'Town', t, dist[0]);
            updateCountUI('req-out', 'Out', o, dist[1]);
            updateCountUI('req-min', 'Min', m, dist[2]);
            updateCountUI('req-dem', 'Dem', d, dist[3]);

            const valid = (t===dist[0] && o===dist[1] && m===dist[2] && d===dist[3]);
            document.getElementById('btn-start-game').disabled = !valid;
        }

        function updateCountUI(id, label, current, required) {
            const el = document.getElementById(id);
            el.innerHTML = `${label}: ${current}/${required}`;
            el.className = `count-item ${current === required ? 'valid' : 'invalid'}`;
        }

        // --- STEP 2: ENTER GAME ---
        function enterGame() {
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            
            // Pre-populate edit dropdown with ONLY selected roles (plus basic ones)
            const sel = document.getElementById('edit-role');
            sel.innerHTML = '<option value="">Unknown</option>';
            
            Object.keys(selectedRoles).forEach(type => {
                if(selectedRoles[type].length > 0) {
                    const grp = document.createElement('optgroup');
                    grp.label = type;
                    selectedRoles[type].forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r;
                        opt.innerText = r;
                        grp.appendChild(opt);
                    });
                    sel.appendChild(grp);
                }
            });
        }

        // --- STEP 3: GAMEPLAY ---
        function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            if(!name) return;
            
            const id = pIdCounter++;
            const p = { id, name, role: '', align: 'good', dead: false, ghostUsed: false, x: 0, y: 0 };
            players.push(p);
            
            // Create DOM
            const el = document.createElement('div');
            el.className = 'player-token good';
            el.id = `p-${id}`;
            el.innerHTML = `
                <div class="token-name">${name}</div>
                <div class="token-role"></div>
            `;
            
            // Center spawn
            el.style.left = 'calc(50% - 45px)';
            el.style.top = 'calc(50% - 45px)';

            // Events
            el.onmousedown = (e) => startDrag(e, el, p);
            el.ondblclick = () => openEdit(p);

            document.getElementById('game-area').appendChild(el);
            input.value = '';
        }

        // --- DRAGGING PHYSICS ---
        function startDrag(e, el, p) {
            // Check if clicking ghost vote
            if(e.target.classList.contains('ghost-vote')) return;

            e.preventDefault();
            
            // Center immediately under cursor
            const moveAt = (pageX, pageY) => {
                // We need to account for sidebar offset
                const sidebarW = document.getElementById('sidebar').offsetWidth;
                el.style.left = (pageX - sidebarW - 45) + 'px'; // 45 is half width
                el.style.top = (pageY - 45) + 'px';
            };

            moveAt(e.pageX, e.pageY);

            function onMouseMove(event) {
                moveAt(event.pageX, event.pageY);
            }

            document.addEventListener('mousemove', onMouseMove);

            document.onmouseup = function() {
                document.removeEventListener('mousemove', onMouseMove);
                document.onmouseup = null;
            };
        }

        // --- EDITING ---
        function openEdit(p) {
            editingId = p.id;
            document.getElementById('edit-role').value = p.role;
            document.getElementById('edit-align').value = p.align;
            document.getElementById('btn-kill').innerText = p.dead ? "Revive" : "Kill";
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-edit').classList.add('hidden');
            editingId = null;
        }

        function saveEdit() {
            const p = players.find(x => x.id === editingId);
            p.role = document.getElementById('edit-role').value;
            p.align = document.getElementById('edit-align').value;
            updateToken(p);
            closeModal();
        }

        function toggleLife() {
            const p = players.find(x => x.id === editingId);
            p.dead = !p.dead;
            log(`${p.name} is now ${p.dead ? 'Dead' : 'Alive'}.`);
            updateToken(p);
            closeModal();
        }

        function updateToken(p) {
            const el = document.getElementById(`p-${p.id}`);
            el.className = `player-token ${p.align} ${p.dead ? 'dead' : ''}`;
            el.querySelector('.token-role').innerText = p.role;
            
            // Handle Ghost Vote UI
            const existingVote = el.querySelector('.ghost-vote');
            if(existingVote) existingVote.remove();
            
            if(p.dead) {
                const g = document.createElement('div');
                g.className = `ghost-vote ${p.ghostUsed ? 'used' : ''}`;
                g.onmousedown = (e) => {
                    e.stopPropagation();
                    p.ghostUsed = !p.ghostUsed;
                    g.className = `ghost-vote ${p.ghostUsed ? 'used' : ''}`;
                    log(`${p.name} ${p.ghostUsed ? 'used' : 'regained'} ghost vote.`);
                };
                el.appendChild(g);
            }
        }

        // --- GAME LOG ---
        function log(msg) {
            const d = document.createElement('div');
            d.innerText = msg;
            document.getElementById('game-log').prepend(d);
        }

        function nextPhase() {
            const phases = ["Setup", "Night 1", "Day 1", "Night 2", "Day 2", "Night 3", "Day 3"];
            phase++;
            const txt = phases[phase] || `Day/Night ${Math.ceil(phase/2)}`;
            document.getElementById('phase-display').innerText = txt;
            log(`--- ${txt} ---`);
        }

    </script>
</body>
</html>
