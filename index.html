<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimoire Companion V5</title>
    <style>
        :root {
            --bg-dark: #0f0f13;
            --bg-panel: #1a1b20;
            --accent: #7c4dff; /* Deep Purple */
            --accent-hover: #651fff;
            --text-main: #eceff1;
            --text-muted: #90a4ae;
            --border: #2c2e35;
            --good: #66bb6a;
            --evil: #ef5350;
            --warn: #ffa726;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- BUTTONS & INPUTS --- */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
        .btn:disabled { background: #333; color: #555; cursor: not-allowed; transform: none; }
        .btn-icon { padding: 8px; border-radius: 50%; width: 36px; height: 36px; }
        
        /* --- SCREENS --- */
        .screen { position: fixed; inset: 0; background: var(--bg-dark); z-index: 10; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* --- SPLASH SCREEN --- */
        #screen-splash { align-items: center; justify-content: center; z-index: 50; }
        .script-container { display: flex; gap: 20px; margin-top: 40px; }
        .script-card {
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            width: 240px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .script-card:hover { border-color: var(--accent); transform: scale(1.05); }
        .script-card h3 { margin: 0 0 10px 0; font-size: 1.4rem; }
        .script-card p { color: var(--text-muted); margin: 0; font-size: 0.9rem; }

        /* --- SETUP SCREEN --- */
        #screen-setup { padding: 30px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        
        /* Custom Stepper */
        .stepper { display: flex; align-items: center; background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .stepper button { background: transparent; border: none; color: var(--text-main); font-size: 1.2rem; padding: 10px 15px; cursor: pointer; }
        .stepper button:hover { background: rgba(255,255,255,0.1); }
        .stepper span { font-size: 1.5rem; font-weight: bold; padding: 0 15px; min-width: 50px; text-align: center; }

        .counts-display { display: flex; gap: 15px; }
        .count-pill { background: var(--bg-panel); padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); font-size: 0.9rem; font-weight: bold; }
        .count-pill.valid { color: var(--good); border-color: var(--good); }
        .count-pill.invalid { color: var(--evil); border-color: var(--evil); }

        #role-selection { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .role-col h3 { text-align: center; color: var(--text-muted); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .role-item { 
            padding: 10px; margin-bottom: 6px; background: #23242a; border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: 0.1s; display: flex; justify-content: space-between;
        }
        .role-item:hover { background: #2c2d35; }
        .role-item.selected { background: var(--accent); border-color: var(--accent-hover); color: white; }
        .modifier-tag { font-size: 0.7rem; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }

        /* --- GAME SCREEN --- */
        #screen-game { display: flex; flex-direction: row; }
        #sidebar { width: 320px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 100; }
        
        #game-board { flex-grow: 1; position: relative; background: radial-gradient(circle at center, #1a1b20 0%, #0f0f13 100%); overflow: hidden; }
        
        /* Town Circle Visual */
        #town-circle-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 600px; border: 2px dashed #333; border-radius: 50%; pointer-events: none;
        }

        /* Player Token */
        .token {
            position: absolute; width: 100px; height: 100px; 
            background: #25262c; border: 3px solid #555; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); cursor: grab; z-index: 20;
        }
        .token:active { cursor: grabbing; z-index: 100; box-shadow: 0 8px 20px rgba(0,0,0,0.7); }
        
        .token.good { border-color: var(--good); background: #1e3020; }
        .token.evil { border-color: var(--evil); background: #351a1a; }
        .token.dead { filter: grayscale(100%); opacity: 0.7; border-style: dotted; }

        .token-name { font-weight: 700; font-size: 0.9rem; pointer-events: none; margin-bottom: 2px; }
        .token-role { font-size: 0.75rem; color: #ccc; pointer-events: none; max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Token Controls */
        .token-ctrl {
            position: absolute; width: 24px; height: 24px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: 0.2s;
        }
        .token-ctrl:hover { transform: scale(1.1); }
        
        /* Eye Icon (Show Card) */
        .ctrl-eye { top: -5px; right: -5px; background: var(--accent); color: white; border: 2px solid var(--bg-dark); font-size: 14px; }
        
        /* Ghost Vote */
        .ctrl-vote { bottom: -8px; left: 50%; transform: translateX(-50%); background: white; border: 2px solid #333; width: 20px; height: 20px; }
        .ctrl-vote.used { background: #444; border-color: #666; }

        /* --- FULL SCREEN CARD MODAL --- */
        #card-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .card-view {
            width: 300px; height: 450px; background: #eceff1; color: #111;
            border-radius: 20px; padding: 20px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(124, 77, 255, 0.3); border: 8px solid #111;
        }
        .card-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .card-type { font-size: 1rem; font-weight: bold; color: #555; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }
        .card-desc { font-size: 1.1rem; line-height: 1.5; font-style: italic; }

        /* --- LOG & MISC --- */
        #game-log { flex-grow: 1; background: #111; border-radius: 6px; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #888; margin-top: 15px; border: 1px solid var(--border); }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .phase-header { color: var(--warn); font-weight: bold; margin: 10px 0; display: block; }
        
        /* Editor Modal */
        #edit-modal { background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-panel); padding: 25px; border-radius: 12px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-box h3 { margin-top: 0; }
        select, input[type="text"] { width: 100%; padding: 10px; margin-bottom: 15px; background: #2c2e35; border: 1px solid #444; color: white; border-radius: 4px; }

    </style>
</head>
<body>

    <div id="screen-splash" class="screen">
        <h1 style="font-size: 3rem; margin-bottom: 0;">Grimoire V5</h1>
        <p style="color: var(--text-muted);">The Unofficial Companion App</p>
        
        <div class="script-container">
            <div class="script-card" onclick="initSetup('TB')">
                <h3>Trouble Brewing</h3>
                <p>Beginner Friendly<br>Basic Deduction</p>
            </div>
            <div class="script-card" onclick="initSetup('BM')">
                <h3>Bad Moon Rising</h3>
                <p>Death Focused<br>Gambling & Chaos</p>
            </div>
            <div class="script-card" onclick="initSetup('SV')">
                <h3>Sects & Violets</h3>
                <p>Information Overload<br>Madness Mechanics</p>
            </div>
        </div>
    </div>

    <div id="screen-setup" class="screen hidden">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap: 20px;">
                <div>
                    <label style="font-size: 0.8rem; color: var(--text-muted); display:block; margin-bottom:5px;">PLAYERS</label>
                    <div class="stepper">
                        <button onclick="changePlayerCount(-1)">‚àí</button>
                        <span id="p-count">5</span>
                        <button onclick="changePlayerCount(1)">+</button>
                    </div>
                </div>
                <div class="counts-display">
                    <div class="count-pill" id="req-town">Town: 0/3</div>
                    <div class="count-pill" id="req-out">Out: 0/0</div>
                    <div class="count-pill" id="req-min">Min: 0/1</div>
                    <div class="count-pill" id="req-dem">Dem: 0/1</div>
                </div>
            </div>
            <button class="btn" id="btn-start" disabled onclick="enterGame()">
                ENTER TOWN SQUARE &rarr;
            </button>
        </div>
        
        <div id="role-selection"></div>
    </div>

    <div id="screen-game" class="screen hidden">
        <div id="sidebar">
            <h3 style="margin-top:0;">Grimoire Controls</h3>
            
            <input type="text" id="input-name" placeholder="New Player Name..." onkeypress="if(event.key==='Enter') addPlayer()">
            <button class="btn" onclick="addPlayer()">+ Add Player</button>
            
            <div style="margin: 15px 0; border-top: 1px solid var(--border); padding-top: 15px;">
                <button class="btn" style="width:100%; background: #444;" onclick="randomizeRoles()">
                     üé≤ Shuffle & Assign Roles
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
                <div id="phase-display" style="font-weight: bold; font-size: 1.2rem;">Setup</div>
                <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="advancePhase()">Next Phase</button>
            </div>
            
            <div id="game-log"></div>
        </div>

        <div id="game-board">
            <div id="town-circle-guide"></div>
            </div>
    </div>

    <div id="card-modal" class="hidden" onclick="this.classList.add('hidden')">
        <div class="card-view" onclick="event.stopPropagation()"> <div class="card-title" id="card-view-name">IMP</div>
            <div class="card-type" id="card-view-type">DEMON</div>
            <div class="card-desc" id="card-view-desc">Each night*, choose a player: they die. If you kill yourself this way, a Minion becomes the Imp.</div>
            <div style="margin-top: 20px; font-size: 0.8rem; color: #666;">(Click anywhere to close)</div>
        </div>
    </div>

    <div id="edit-modal" class="screen hidden">
        <div class="modal-box">
            <h3>Edit Player</h3>
            <label>Role</label>
            <select id="edit-role"></select>
            <label>Alignment</label>
            <select id="edit-align">
                <option value="good">Good</option>
                <option value="evil">Evil</option>
            </select>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" onclick="saveEdit()">Save</button>
                <button class="btn" style="background:var(--evil);" id="btn-kill" onclick="toggleLife()">Kill</button>
                <button class="btn" style="background:#555;" onclick="document.getElementById('edit-modal').classList.add('hidden')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const scripts = {
            TB: {
                Townsfolk: [
                    {n:"Washerwoman", d:"Start knowing 1 of 2 players is a specific Townsfolk."},
                    {n:"Librarian", d:"Start knowing 1 of 2 players is a specific Outsider."},
                    {n:"Investigator", d:"Start knowing 1 of 2 players is a specific Minion."},
                    {n:"Chef", d:"Start knowing how many pairs of evil players are neighbors."},
                    {n:"Empath", d:"Each night, learn how many of your 2 alive neighbors are evil."},
                    {n:"Fortune Teller", d:"Each night, choose 2 players: learn if either is a Demon."},
                    {n:"Undertaker", d:"Each night, learn which character died by execution today."},
                    {n:"Monk", d:"Each night, choose a player (not yourself): they are safe from the Demon tonight."},
                    {n:"Ravenkeeper", d:"If you die at night, you are woken to choose a player: you learn their character."},
                    {n:"Virgin", d:"The 1st time you are nominated by a Townsfolk, you are executed if the nominee is a Townsfolk."},
                    {n:"Slayer", d:"Once per game, during the day, publicly choose a player: if they are the Demon, they die."},
                    {n:"Soldier", d:"You are safe from the Demon."},
                    {n:"Mayor", d:"If no one dies by execution, you might win. If you die at night, another player might die instead."}
                ],
                Outsider: [
                    {n:"Butler", d:"Each night, choose a player (not yourself): tomorrow, you may only vote if they vote too."},
                    {n:"Drunk", d:"You do not know you are the Drunk. You think you are a Townsfolk, but you are not."},
                    {n:"Recluse", d:"You might register as evil & as a Minion or Demon, even if dead."},
                    {n:"Saint", d:"If you die by execution, your team loses."}
                ],
                Minion: [
                    {n:"Poisoner", d:"Each night, choose a player: they are poisoned tonight and tomorrow day."},
                    {n:"Spy", d:"Each night, you see the Grimoire. You might register as good & as a Townsfolk or Outsider."},
                    {n:"Scarlet Woman", d:"If there are 5 or more players alive & the Demon dies, you become the Demon."},
                    {n:"Baron", d:"There are extra Outsiders in play. [+2 Outsiders]"}
                ],
                Demon: [
                    {n:"Imp", d:"Each night*, choose a player: they die. If you kill yourself this way, a Minion becomes the Imp."}
                ]
            }
            // Add other scripts here following same structure if needed
        };

        // Fallback simple lists for BM/SV for this demo
        const simpleList = (arr) => arr.map(s => ({n:s, d:"Ability description placeholder."}));
        scripts.BM = {
            Townsfolk: simpleList(["Grandmother", "Sailor", "Chambermaid", "Exorcist", "Innkeeper", "Gambler", "Gossip", "Courtier", "Professor", "Minstrel", "Tea Lady", "Pacifist", "Fool"]),
            Outsider: simpleList(["Tinker", "Moonchild", "Goon", "Lunatic"]),
            Minion: simpleList(["Godfather", "Devil's Advocate", "Assassin", "Mastermind"]),
            Demon: simpleList(["Zombuul", "Pukka", "Shabaloth", "Po"])
        };
        scripts.SV = {
            Townsfolk: simpleList(["Clockmaker", "Dreamer", "Snake Charmer", "Mathematician", "Flowergirl", "Town Crier", "Oracle", "Savant", "Seamstress", "Philosopher", "Artist", "Juggler", "Sage"]),
            Outsider: simpleList(["Mutant", "Sweetheart", "Barber", "Klutz"]),
            Minion: simpleList(["Witch", "Cerebus", "Pit-Hag", "Evil Twin"]),
            Demon: simpleList(["Fang Gu", "Vortox", "No Dashii", "Vigormortis"])
        };

        // Add special data for modifiers
        scripts.BM.Minion[0].d = "Start knowing which Outsiders are in play. If 1 died today, choose a player: they die. [+1 Outsider]"; // Godfather

        // Base distribution table
        const baseDist = {
            5: [3,0,1,1], 6: [3,1,1,1], 7: [5,0,1,1], 8: [5,1,1,1], 9: [5,2,1,1],
            10: [7,0,2,1], 11: [7,1,2,1], 12: [7,2,2,1], 13: [9,0,3,1], 14: [9,1,3,1], 15: [9,2,3,1]
        };

        // --- STATE ---
        let appState = {
            script: 'TB',
            playerCount: 5,
            selected: { Townsfolk:[], Outsider:[], Minion:[], Demon:[] },
            players: [],
            phaseIdx: 0
        };

        // --- SETUP LOGIC ---
        function initSetup(code) {
            appState.script = code;
            document.getElementById('screen-splash').classList.add('hidden');
            document.getElementById('screen-setup').classList.remove('hidden');
            renderSetupGrid();
            updateCalc();
        }

        function changePlayerCount(delta) {
            let n = appState.playerCount + delta;
            if(n < 5) n = 5; 
            if(n > 15) n = 15;
            appState.playerCount = n;
            document.getElementById('p-count').innerText = n;
            updateCalc();
        }

        function renderSetupGrid() {
            const container = document.getElementById('role-selection');
            container.innerHTML = '';
            const data = scripts[appState.script];

            for(let type in data) {
                const col = document.createElement('div');
                col.className = 'role-col';
                col.innerHTML = `<h3>${type}</h3>`;
                
                data[type].forEach(roleObj => {
                    const div = document.createElement('div');
                    div.className = 'role-item';
                    div.innerHTML = `<span>${roleObj.n}</span>`;
                    
                    // Add modifier tags
                    if(roleObj.n === "Baron") div.innerHTML += `<span class="modifier-tag">+2 Out</span>`;
                    if(roleObj.n === "Godfather") div.innerHTML += `<span class="modifier-tag">+1 Out</span>`;

                    div.onclick = () => toggleRole(type, roleObj.n, div);
                    col.appendChild(div);
                });
                container.appendChild(col);
            }
        }

        function toggleRole(type, name, el) {
            const list = appState.selected[type];
            const idx = list.indexOf(name);
            if(idx > -1) {
                list.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                list.push(name);
                el.classList.add('selected');
            }
            updateCalc();
        }

        function updateCalc() {
            // 1. Get Base
            let req = [...(baseDist[appState.playerCount] || [3,0,1,1])]; // [Town, Out, Min, Dem]
            
            // 2. Apply Modifiers
            // Baron check
            if(appState.selected.Minion.includes("Baron")) {
                req[0] -= 2; // -Town
                req[1] += 2; // +Out
            }
            // Godfather check (only if script is BM or custom)
            if(appState.selected.Minion.includes("Godfather")) {
                req[0] -= 1;
                req[1] += 1;
            }

            // 3. Update UI
            const setUI = (id, cur, max) => {
                const el = document.getElementById(id);
                // Map array index to string label
                const label = id.split('-')[1].charAt(0).toUpperCase() + id.split('-')[1].slice(1);
                el.innerText = `${label}: ${cur}/${max}`;
                el.className = `count-pill ${cur === max ? 'valid' : 'invalid'}`;
                return cur === max;
            };

            const v1 = setUI('req-town', appState.selected.Townsfolk.length, req[0]);
            const v2 = setUI('req-out', appState.selected.Outsider.length, req[1]);
            const v3 = setUI('req-min', appState.selected.Minion.length, req[2]);
            const v4 = setUI('req-dem', appState.selected.Demon.length, req[3]);

            document.getElementById('btn-start').disabled = !(v1 && v2 && v3 && v4);
        }

        function enterGame() {
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            log("Welcome to Ravenswood Bluff.");
        }

        // --- GAMEPLAY & DRAGGING ---
        let dragTarget = null;
        let dragOffset = {x:0, y:0};

        function addPlayer() {
            const input = document.getElementById('input-name');
            const name = input.value.trim();
            if(!name) return;
            
            const id = Date.now();
            const p = { id, name, role: "Unknown", align: "good", dead: false, ghostUsed: false };
            appState.players.push(p);

            // Create Token
            const el = document.createElement('div');
            el.className = 'token good';
            el.id = `token-${id}`;
            el.style.left = `calc(50% - 50px)`; // Center spawn
            el.style.top = `calc(50% - 50px)`;
            
            el.innerHTML = `
                <div class="token-name">${name}</div>
                <div class="token-role" id="role-text-${id}"></div>
                <div class="token-ctrl ctrl-eye" title="View Card" onmousedown="viewCard(event, ${id})">üëÅ</div>
            `;
            
            el.onmousedown = (e) => startDrag(e, el);
            el.ondblclick = () => openEdit(id);
            
            document.getElementById('game-board').appendChild(el);
            input.value = '';
            log(`Added ${name}.`);
        }

        function startDrag(e, el) {
            // Ignore if clicking controls
            if(e.target.classList.contains('token-ctrl')) return;

            dragTarget = el;
            const rect = el.getBoundingClientRect();
            
            // Calculate offset from the Top-Left of the element to the mouse
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if(!dragTarget) return;
            const board = document.getElementById('game-board');
            const boardRect = board.getBoundingClientRect();
            
            // Calculate new position relative to board
            let newX = e.clientX - boardRect.left - dragOffset.x;
            let newY = e.clientY - boardRect.top - dragOffset.y;

            dragTarget.style.left = newX + 'px';
            dragTarget.style.top = newY + 'px';
        }

        function stopDrag() {
            dragTarget = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // --- FEATURES ---
        
        function randomizeRoles() {
            if(appState.players.length === 0) return alert("Add players first!");
            
            // Gather all selected roles
            let pool = [];
            ['Townsfolk', 'Outsider', 'Minion', 'Demon'].forEach(t => {
                pool = pool.concat(appState.selected[t]);
            });

            if(pool.length !== appState.players.length) {
                // Allow shuffle even if mismatch, but warn
                if(!confirm(`You have ${pool.length} roles and ${appState.players.length} players. Shuffle anyway?`)) return;
            }

            // Shuffle
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }

            // Assign
            appState.players.forEach((p, index) => {
                if(pool[index]) {
                    p.role = pool[index];
                    // Auto set alignment based on type
                    const rType = getRoleType(p.role);
                    p.align = (rType === 'Demon' || rType === 'Minion') ? 'evil' : 'good';
                    updateTokenUI(p);
                }
            });
            log("Roles shuffled and assigned.");
        }

        function getRoleType(roleName) {
            // Helper to find type
            const data = scripts[appState.script];
            if(data.Townsfolk.find(r => r.n === roleName)) return 'Townsfolk';
            if(data.Outsider.find(r => r.n === roleName)) return 'Outsider';
            if(data.Minion.find(r => r.n === roleName)) return 'Minion';
            if(data.Demon.find(r => r.n === roleName)) return 'Demon';
            return 'Unknown';
        }

        function viewCard(e, id) {
            e.stopPropagation(); // prevent drag
            const p = appState.players.find(x => x.id === id);
            if(!p.role || p.role === "Unknown") return alert("Assign a role first.");

            const type = getRoleType(p.role);
            const data = scripts[appState.script][type].find(r => r.n === p.role);

            document.getElementById('card-view-name').innerText = p.role;
            document.getElementById('card-view-type').innerText = type;
            document.getElementById('card-view-desc').innerText = data ? data.d : "No description available.";
            
            document.getElementById('card-modal').classList.remove('hidden');
        }

        // --- EDITING ---
        let editId = null;
        function openEdit(id) {
            editId = id;
            const p = appState.players.find(x => x.id === id);
            const modal = document.getElementById('edit-modal');
            
            // Populate Dropdown
            const sel = document.getElementById('edit-role');
            sel.innerHTML = '<option value="">-- None --</option>';
            // Add all selected roles to dropdown
            ['Townsfolk', 'Outsider', 'Minion', 'Demon'].forEach(t => {
                const grp = document.createElement('optgroup');
                grp.label = t;
                appState.selected[t].forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.innerText = r;
                    grp.appendChild(opt);
                });
                sel.appendChild(grp);
            });

            sel.value = p.role;
            document.getElementById('edit-align').value = p.align;
            document.getElementById('btn-kill').innerText = p.dead ? "Revive" : "Kill";
            modal.classList.remove('hidden');
        }

        function saveEdit() {
            const p = appState.players.find(x => x.id === editId);
            p.role = document.getElementById('edit-role').value;
            p.align = document.getElementById('edit-align').value;
            updateTokenUI(p);
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function toggleLife() {
            const p = appState.players.find(x => x.id === editId);
            p.dead = !p.dead;
            updateTokenUI(p);
            log(`${p.name} is now ${p.dead ? 'Dead' : 'Alive'}.`);
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function updateTokenUI(p) {
            const el = document.getElementById(`token-${p.id}`);
            el.className = `token ${p.align} ${p.dead ? 'dead' : ''}`;
            document.getElementById(`role-text-${p.id}`).innerText = p.role;

            // Ghost vote logic
            const oldVote = el.querySelector('.ctrl-vote');
            if(oldVote) oldVote.remove();

            if(p.dead) {
                const gv = document.createElement('div');
                gv.className = `token-ctrl ctrl-vote ${p.ghostUsed ? 'used' : ''}`;
                gv.onmousedown = (e) => {
                    e.stopPropagation();
                    p.ghostUsed = !p.ghostUsed;
                    gv.className = `token-ctrl ctrl-vote ${p.ghostUsed ? 'used' : ''}`;
                    log(`${p.name} ${p.ghostUsed ? 'spent' : 'recovered'} ghost vote.`);
                }
                el.appendChild(gv);
            }
        }

        function log(msg) {
            const d = document.createElement('div');
            d.className = 'log-line';
            d.innerText = msg;
            document.getElementById('game-log').prepend(d);
        }

        function advancePhase() {
            const phases = ["Night", "Day"];
            appState.phaseIdx++;
            const num = Math.ceil(appState.phaseIdx / 2);
            const isNight = appState.phaseIdx % 2 !== 0;
            const pName = `${isNight ? 'Night' : 'Day'} ${num}`;
            document.getElementById('phase-display').innerText = pName;
            log(`--- ${pName} ---`);
        }

    </script>
</body>
</html>
